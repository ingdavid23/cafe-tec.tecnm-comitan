<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAFE-TEC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .bg-preview {
            background-size: cover;
            background-position: center;
        }
    </style>

<body class="bg-gray-50 max-w-md mx-auto min-h-screen">
    <div id="loginScreen"
        class="h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex flex-col items-center justify-start pt-12 text-white relative overflow-y-auto">
        <div class="absolute inset-0 opacity-10">
            <svg class="w-full h-full" viewBox="0 0 100 100" fill="currentColor">
                <circle cx="20" cy="20" r="2" />
                <circle cx="80" cy="30" r="1.5" />
                <circle cx="60" cy="70" r="1" />
                <circle cx="30" cy="80" r="2.5" />
                <circle cx="90" cy="60" r="1" />
            </svg>
        </div>

        <div class="text-center z-10 fade-in w-full max-w-sm px-6">
            <div class="mb-8">
                <svg class="w-24 h-24 mx-auto mb-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M18.5 3H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12.5c.8 0 1.5-.7 1.5-1.5v-15c0-.8-.7-1.5-1.5-1.5zM18 19H6V5h12v14zM8 15h8v2H8v-2zm0-4h8v2H8v-2zm0-4h5v2H8V7z" />
                </svg>
            </div>
            <h1 class="text-4xl font-bold mb-2 tracking-wide">CAFE-TEC</h1>
            <p class="text-lg opacity-90 mb-8">Bienvenido a tu cafeter√≠a tecnol√≥gica</p>

            <div id="loginForm" class="space-y-4">
                <div>
                    <input type="text" id="loginUser"
                        class="w-full px-4 py-3 rounded-lg text-gray-800 placeholder-gray-500"
                        placeholder="Usuario, No. Control o Tel√©fono">
                </div>
                <div class="relative">
                    <input type="password" id="loginPassword"
                        class="w-full pl-4 pr-10 py-3 rounded-lg text-gray-800 placeholder-gray-500"
                        placeholder="Contrase√±a">
                    <button type="button" onclick="togglePasswordVisibility('loginPassword')"
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                        <svg class="h-5 w-5 hidden" id="eye-icon-loginPassword" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg class="h-5 w-5" id="eye-slash-icon-loginPassword" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" />
                        </svg>
                    </button>
                </div>
                <button onclick="login()"
                    class="w-full bg-white text-blue-700 py-3 px-6 rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    üîê Iniciar Sesi√≥n
                </button>
                <button onclick="showRegister()"
                    class="w-full bg-blue-800 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 border-2 border-white">
                    üìù Registrarse
                </button>
                <button onclick="showPasswordResetModal()"
                    class="w-full bg-blue-800 bg-opacity-70 text-white py-2 px-6 rounded-lg font-medium text-sm hover:shadow-xl transform hover:scale-105 transition-all duration-200 border border-white">
                    üîë ¬øOlvidaste tu Contrase√±a?
                </button>

                <div id="loginMessage" class="mt-4 hidden rounded-lg px-4 py-3 text-sm font-medium"></div>
            </div>
        </div>
    </div>

    <div id="registerScreen"
        class="hidden h-screen bg-gradient-to-br from-green-600 to-teal-700 text-white flex flex-col">
        <div class="p-6 overflow-y-auto flex-grow">
            <div class="flex items-center mb-6">
                <button onclick="showLogin()"
                    class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-2xl font-bold">Registro de Usuario</h2>
            </div>

            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Tipo de Usuario</label>
                    <select id="userType" class="w-full px-4 py-3 rounded-lg text-gray-800"
                        onchange="toggleUserFields()" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="estudiante">üë®‚Äçüéì Estudiante</option>
                        <option value="docente">üë©‚Äçüè´ Docente</option>
                        <option value="administrativo">üë®‚Äçüíº Administrativo</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Nombre Completo</label>
                    <input type="text" id="fullName" class="w-full px-4 py-3 rounded-lg text-gray-800" required>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Tecnol√≥gico</label>
                    <input type="text" id="tecnologico" class="w-full px-4 py-3 rounded-lg text-gray-800"
                        placeholder="Ej: TecNM campus Comit√°n" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Nombre de Usuario (√önico)</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-lg text-gray-800"
                        placeholder="Ej: miusuario_cafetec" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Contrase√±a</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full pl-4 pr-10 py-3 rounded-lg text-gray-800"
                            required>
                        <button type="button" onclick="togglePasswordVisibility('password')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                            <svg class="h-5 w-5 hidden" id="eye-icon-password" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg class="h-5 w-5" id="eye-slash-icon-password" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Confirmar Contrase√±a</label>
                    <div class="relative">
                        <input type="password" id="confirmPassword"
                            class="w-full pl-4 pr-10 py-3 rounded-lg text-gray-800" required>
                        <button type="button" onclick="togglePasswordVisibility('confirmPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                            <svg class="h-5 w-5 hidden" id="eye-icon-confirmPassword" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg class="h-5 w-5" id="eye-slash-icon-confirmPassword" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="studentFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">N√∫mero de Control</label>
                        <input type="text" id="controlNumber" class="w-full px-4 py-3 rounded-lg text-gray-800"
                            placeholder="Ej: 20230001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Carrera</label>
                        <select id="career" class="w-full px-4 py-3 rounded-lg text-gray-800">
                            <option value="">Seleccionar carrera</option>
                            <option value="Ingenier√≠a en Sistemas Computacionales">Ingenier√≠a en Sistemas
                                Computacionales</option>
                            <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                            <option value="Ingenier√≠a Electr√≥nica">Ingenier√≠a Electr√≥nica</option>
                            <option value="Ingenier√≠a Mec√°nica">Ingenier√≠a Mec√°nica</option>
                            <option value="Ingenier√≠a Civil">Ingenier√≠a Civil</option>
                            <option value="Licenciatura en Administraci√≥n">Licenciatura en Administraci√≥n</option>
                            <option value="Contador P√∫blico">Contador P√∫blico</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Semestre</label>
                            <select id="semester" class="w-full px-4 py-3 rounded-lg text-gray-800">
                                <option value="">Seleccionar</option>
                                <option value="1">1¬∞</option>
                                <option value="2">2¬∞</option>
                                <option value="3">3¬∞</option>
                                <option value="4">4¬∞</option>
                                <option value="5">5¬∞</option>
                                <option value="6">6¬∞</option>
                                <option value="7">7¬∞</option>
                                <option value="8">8¬∞</option>
                                <option value="9">9¬∞</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Grupo</label>
                            <select id="group" class="w-full px-4 py-3 rounded-lg text-gray-800">
                                <option value="">Seleccionar</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="staffFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">N√∫mero de Tel√©fono</label>
                        <input type="tel" id="phoneNumber" class="w-full px-4 py-3 rounded-lg text-gray-800"
                            placeholder="Ej: 5551234567">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Credencial Escolar</label>
                    <div class="border-2 border-dashed border-white border-opacity-50 rounded-lg p-4 text-center">
                        <input type="file" id="credentialFile" accept="image/*" class="hidden"
                            onchange="previewCredential()">
                        <button type="button" onclick="document.getElementById('credentialFile').click()"
                            class="w-full py-3 px-4 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-colors">
                            üì∑ Subir Credencial
                        </button>
                        <div id="credentialPreview" class="hidden mt-4">
                            <img id="credentialImage"
                                class="w-32 h-20 object-cover mx-auto rounded-lg border-2 border-white">
                            <p class="text-sm mt-2 opacity-75">Credencial cargada ‚úì</p>
                        </div>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-white text-green-700 py-3 px-6 rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    ‚úÖ Registrarse
                </button>
            </form>
        </div>
    </div>
    <div id="welcomeScreen"
        class="hidden min-h-screen bg-gradient-to-br from-amber-600 to-orange-700 flex flex-col items-center justify-center text-white relative overflow-hidden">
        <div class="absolute inset-0 opacity-10">
            <svg class="w-full h-full" viewBox="0 0 100 100" fill="currentColor">
                <circle cx="20" cy="20" r="2" />
                <circle cx="80" cy="30" r="1.5" />
                <circle cx="60" cy="70" r="1" />
                <circle cx="30" cy="80" r="2.5" />
                <circle cx="90" cy="60" r="1" />
            </svg>
        </div>

        <div class="text-center z-10 fade-in">
            <div class="mb-8">
                <svg class="w-24 h-24 mx-auto mb-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M18.5 3H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12.5c.8 0 1.5-.7 1.5-1.5v-15c0-.8-.7-1.5-1.5-1.5zM18 19H6V5h12v14zM8 15h8v2H8v-2zm0-4h8v2H8v-2zm0-4h5v2H8V7z" />
                </svg>
            </div>
            <h1 class="text-5xl font-bold mb-2 tracking-wide">CAFE-TEC</h1>
            <p class="text-xl opacity-90 mb-2">¬°Bienvenido/a!</p>
            <p id="welcomeUserName" class="text-lg opacity-75 mb-8"></p>
            <div class="space-y-4">
                <button onclick="showCustomerMenu()"
                    class="w-64 bg-white text-amber-700 py-4 px-8 rounded-full font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    üçΩÔ∏è Men√∫ Cliente
                </button>
                <button onclick="logout()"
                    class="w-64 bg-amber-800 text-white py-4 px-8 rounded-full font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 border-2 border-white">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </div>
    <div id="customerMenu" class="hidden h-screen bg-white flex flex-col">
        <div class="bg-gradient-to-r from-amber-600 to-orange-600 text-white p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <button onclick="showWelcome()"
                    class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold">CAFE-TEC Men√∫</h2>
                <button onclick="showCart()"
                    class="relative p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01" />
                    </svg>
                    <span id="cartCount"
                        class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </div>
        <div class="p-4 flex-grow overflow-y-auto">
            <div class="flex space-x-2 mb-6 overflow-x-auto">
                <button onclick="filterCategory('all')"
                    class="category-btn bg-amber-600 text-white px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    Todos
                </button>
                <button onclick="filterCategory('bebidas')"
                    class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    ‚òï Bebidas
                </button>
                <button onclick="filterCategory('comida')"
                    class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üçΩÔ∏è Comida
                </button>
                <button onclick="filterCategory('postres')"
                    class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üßÅ Postres
                </button>
                <button onclick="filterCategory('golosinas')"
                    class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üç¨ Golosinas
                </button>
            </div>
            <div id="productList" class="space-y-4">
            </div>
        </div>
    </div>
    <div id="cartScreen" class="hidden h-screen bg-white flex flex-col">
        <div class="bg-gradient-to-r from-amber-600 to-orange-600 text-white p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <button onclick="showCustomerMenu()"
                    class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold">Tu Pedido</h2>
                <div class="w-10"></div>
            </div>
        </div>
        <div class="p-4 flex-grow overflow-y-auto">
            <div id="cartItems" class="space-y-4 mb-6">
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">üìù Notas Especiales</h3>
                <textarea id="orderNotes" class="w-full border rounded-lg px-3 py-2 h-20 resize-none"
                    placeholder="Agrega cualquier nota especial para tu pedido (opcional)"></textarea>
            </div>
            <div class="border-t pt-4 mb-6">
                <div class="flex justify-between items-center text-xl font-bold">
                    <span>Total:</span>
                    <span id="totalPrice">$0.00</span>
                </div>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">üïê Horario de Recogida</h3>
                <div class="grid grid-cols-2 gap-2">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="07:00" class="mr-2" checked>
                        <span class="text-sm">7:00 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="07:30" class="mr-2">
                        <span class="text-sm">7:30 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="08:00" class="mr-2">
                        <span class="text-sm">8:00 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="08:30" class="mr-2">
                        <span class="text-sm">8:30 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="09:00" class="mr-2">
                        <span class="text-sm">9:00 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="09:30" class="mr-2">
                        <span class="text-sm">9:30 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="10:00" class="mr-2">
                        <span class="text-sm">10:00 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="10:30" class="mr-2">
                        <span class="text-sm">10:30 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="11:00" class="mr-2">
                        <span class="text-sm">11:00 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="11:30" class="mr-2">
                        <span class="text-sm">11:30 AM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="12:00" class="mr-2">
                        <span class="text-sm">12:00 PM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="12:30" class="mr-2">
                        <span class="text-sm">12:30 PM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="13:00" class="mr-2">
                        <span class="text-sm">1:00 PM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="13:30" class="mr-2">
                        <span class="text-sm">1:30 PM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="14:00" class="mr-2">
                        <span class="text-sm">2:00 PM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="14:30" class="mr-2">
                        <span class="text-sm">2:30 PM</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="pickup-time" value="15:00" class="mr-2">
                        <span class="text-sm">3:00 PM</span>
                    </label>
                </div>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">üí≥ M√©todo de Pago</h3>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="payment" value="efectivo" class="mr-3" checked
                            onchange="showPaymentDetails()">
                        <span>üíµ Efectivo</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="payment" value="tarjeta" class="mr-3" onchange="showPaymentDetails()">
                        <span>üí≥ Tarjeta</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="payment" value="transferencia" class="mr-3"
                            onchange="showPaymentDetails()">
                        <span>üì± Transferencia</span>
                    </label>
                </div>
                <div id="cardPaymentDetails" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border">
                    <h4 class="font-semibold mb-3 text-blue-800">üí≥ Datos de la Tarjeta</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">N√∫mero de Tarjeta</label>
                            <input type="text" id="cardNumber" class="w-full border rounded-lg px-3 py-2"
                                placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Fecha de Vencimiento</label>
                                <input type="text" id="cardExpiry" class="w-full border rounded-lg px-3 py-2"
                                    placeholder="MM/AA" maxlength="5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">CVV</label>
                                <input type="text" id="cardCvv" class="w-full border rounded-lg px-3 py-2"
                                    placeholder="123" maxlength="3">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Nombre del Titular</label>
                            <input type="text" id="cardHolder" class="w-full border rounded-lg px-3 py-2"
                                placeholder="Nombre como aparece en la tarjeta">
                        </div>
                    </div>
                </div>
                <div id="transferDetails" class="hidden mt-4 p-4 bg-green-50 rounded-lg border">
                    <h4 class="font-semibold mb-3 text-green-800">üì± Datos para Transferencia</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">Banco:</span>
                            <span>BBVA Bancomer</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Cuenta:</span>
                            <span>0123456789</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">CLABE:</span>
                            <span>012345678901234567</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Titular:</span>
                            <span>CAFE-TEC S.A. de C.V.</span>
                        </div>
                        <div class="mt-3 p-2 bg-yellow-100 rounded text-xs text-yellow-800">
                            üí° Env√≠a el comprobante de pago al momento de recoger tu pedido
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="confirmOrder()"
                class="w-full bg-green-600 text-white py-4 rounded-lg font-semibold text-lg hover:bg-green-700 transition-colors">
                Confirmar Pedido
            </button>
        </div>
    </div>

    <div id="adminPanel" class="hidden min-h-screen bg-white">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <button onclick="adminLogout()"
                    class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-bold">Panel Administrador</h2>
                <button onclick="addNewProduct()"
                    class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-4">
            <div class="flex space-x-2 mb-6 overflow-x-auto">
                <button onclick="showAdminStock()" id="stockTab"
                    class="admin-tab bg-blue-600 text-white px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üçΩÔ∏è Stock Productos
                </button>
                <button onclick="showAdminRawMaterials()" id="rawMaterialsTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üì¶ Stock Materia Prima
                </button>
                <button onclick="showAdminSupplierStock()" id="supplierStockTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üõí Stock de Productos de Proveedores
                </button>
                <button onclick="showAdminSupplierPurchases()" id="supplierPurchasesTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üöö Compras a Proveedor
                </button>
                <button onclick="showAdminOrders()" id="ordersTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üìã Pedidos
                </button>
                <button onclick="showAdminStats()" id="statsTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üìä Estad√≠sticas
                </button>
                <button onclick="showAdminPersonalData()" id="personalDataTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üßæ Datos Personales
                </button>
                <button onclick="showAdminUsers()" id="usersTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üë• Usuarios
                </button>
                <button onclick="showAdminMemory()" id="memoryTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üóÉÔ∏è Memoria Local
                </button>
                <button onclick="showAdminReports()" id="reportsTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üìÑ Reportes
                </button>
                <button onclick="showAdminInvoicing()" id="invoicingTab"
                    class="admin-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üßæ Facturaci√≥n
                </button>
                <button onclick="adminLogout()"
                    class="admin-tab bg-red-200 text-red-700 px-4 py-2 rounded-full whitespace-nowrap font-medium">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
            <div id="adminStockSection" class="mb-6">
                <div class="flex space-x-2 mb-4 border-b pb-2">
                    <button onclick="showAdminFinalProducts('manufactured')" id="manufacturedStockTab"
                        class="product-type-tab bg-blue-600 text-white px-3 py-1 text-sm rounded-full font-medium">
                        Hechos en Casa
                    </button>
                    <button onclick="showAdminFinalProducts('supplier')" id="supplierProductsStockTab"
                        class="product-type-tab bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full font-medium">
                        Producto Final de Proveedores
                    </button>
                </div>
                <h3 id="productStockTitle" class="text-lg font-semibold mb-3">Gesti√≥n de Stock de Productos Finales
                    (Hechos en Casa)</h3>
                <div id="adminProductList" class="space-y-3">
                </div>
                <div id="adminSupplierProductList" class="hidden space-y-3">
                </div>
            </div>
            <div id="adminRawMaterialsSection" class="hidden mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Gesti√≥n de Materia Prima</h3>
                    <button onclick="addNewRawMaterial()"
                        class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Nueva MP
                    </button>
                </div>
                <div id="adminRawMaterialsList" class="space-y-3">
                </div>
            </div>
            <div id="adminSupplierStockSection" class="hidden mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Stock de Productos de Proveedores (Refrescos, Papas, etc.)</h3>
                    <button onclick="addNewSupplierProduct()"
                        class="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Nuevo Producto
                    </button>
                </div>
                <div id="adminSupplierStockList" class="space-y-3">
                </div>
            </div>
            <div id="adminSupplierPurchasesSection" class="hidden mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Control de Compras a Proveedor</h3>
                    <button onclick="showNewPurchaseModal()"
                        class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Registrar Compra
                    </button>
                </div>
                <div id="supplierStatsContainer" class="mb-6">
                </div>
                <h3 class="text-lg font-semibold mb-3 border-t pt-4">Historial de Compras</h3>
                <div id="adminSupplierPurchasesList" class="space-y-3">
                </div>
            </div>
            <div id="adminOrdersSection" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-3">Pedidos en Tiempo Real</h3>
                <div id="adminOrdersList" class="space-y-3">
                </div>
            </div>

            <div id="adminInvoicingSection" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-3">üßæ Facturaci√≥n CFDI (Simulada SAT)</h3>
                <p class="text-xs text-gray-500 mb-4">
                    Selecciona un pedido para generar la factura CFDI (simulada) y verla en formato de ticket.
                </p>
                <div id="adminInvoicingList" class="space-y-3"></div>
            </div>

            <div id="adminStatsSection" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-3">üìä Estad√≠sticas de Ventas</h3>
                <div id="adminStatsList" class="space-y-3">
                </div>
            </div>

            <div id="adminPersonalDataSection" class="hidden mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold">üßæ Datos Personales y EdoCta</h3>
                </div>
                <div class="grid grid-cols-1 gap-2 mb-3">
                    <input id="personalSearchInput" type="text" class="border rounded-lg px-3 py-2"
                        placeholder="üîé Buscar por nombre, usuario, tel√©fono, No. control o Tec">
                    <select id="personalFilterSelect" class="border rounded-lg px-3 py-2">
                        <option value="all">Todos los tipos</option>
                        <option value="estudiante">Estudiantes</option>
                        <option value="docente">Docentes</option>
                        <option value="administrativo">Administrativos</option>
                    </select>
                </div>
                <div id="adminPersonalDataList" class="space-y-3"></div>
            </div>
            <div id="adminUsersSection" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-3">Usuarios Registrados</h3>
                <div id="adminUsersList" class="space-y-3">
                </div>
            </div>
            <div id="adminMemorySection" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-3">üóÉÔ∏è Datos Guardados Localmente</h3>
                <div id="memoryList" class="space-y-4">
                </div>
                <button onclick="clearLocalMemory()"
                    class="w-full bg-red-500 text-white py-2 rounded-lg font-medium mt-4 hover:bg-red-600 transition-colors">
                    ‚ö†Ô∏è Borrar Todos los Datos Locales
                </button>
            </div>
            <div id="adminReportsSection" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-3">üìÑ Reporte (Vista previa & Copiar)</h3>
                <div class="space-y-3 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <p class="text-sm text-gray-700">
                        Vista previa de <b>Usuarios</b> y <b>Productos</b> en texto plano. Copia y p√©galo donde
                        necesites.
                    </p>

                    <div class="flex items-center justify-between text-xs text-gray-600">
                        <span id="reportSummary">‚Äî</span>
                        <div class="flex gap-2">
                            <button onclick="copyReportToClipboard()"
                                class="px-3 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                                üìã Copiar texto
                            </button>
                        </div>
                    </div>

                    <textarea id="reportPreview"
                        class="w-full h-72 md:h-96 font-mono text-xs border rounded-lg p-3 bg-white"
                        readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up max-h-[90vh] overflow-y-auto">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">Agregar Producto</h3>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                <input type="hidden" id="productIsSupplier" value="false">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre</label>
                    <input type="text" id="productName" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Emoji (Ej: ‚òï, ü•™)</label>
                    <input type="text" id="productEmoji" class="w-full border rounded-lg px-3 py-2" maxlength="2"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                    <textarea id="productDescription"
                        class="w-full border rounded-lg px-3 py-2 resize-none h-16"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Imagen de Vista Previa</label>
                    <input type="url" id="productImageURL" class="w-full border rounded-lg px-3 py-2 mb-2 text-gray-800"
                        placeholder="Opcional: Enlace URL a la imagen"
                        onchange="document.getElementById('productImageFile').value = ''; document.getElementById('imagePreviewStatus').textContent = this.value ? 'Usando URL ‚úì' : 'Ning√∫n archivo seleccionado.';">

                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500 text-xs">O</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="text-gray-500 text-xs">Cargar Archivo</span>
                    </div>

                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 mt-2 text-center">
                        <input type="file" id="productImageFile" accept="image/*" class="hidden"
                            onchange="previewLocalImage(event)">
                        <button type="button" onclick="document.getElementById('productImageFile').click()"
                            class="w-full py-2 px-4 bg-gray-100 text-blue-600 rounded-lg hover:bg-gray-200 transition-colors">
                            üìÅ Cargar desde Dispositivo
                        </button>
                        <p id="imagePreviewStatus" class="text-xs mt-2 text-gray-600">Ning√∫n archivo seleccionado.</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div id="productTimeField">
                        <label class="block text-sm font-medium mb-1">Tiempo (Ej: 5 min)</label>
                        <input type="text" id="productTime" class="w-full border rounded-lg px-3 py-2"
                            placeholder="Ej: 5 min">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Calor√≠as (Ej: 150 Cal)</label>
                        <input type="text" id="productCalories" class="w-full border rounded-lg px-3 py-2"
                            placeholder="Ej: 150 Cal">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Precio</label>
                    <input type="number" id="productPrice" step="0.01" class="w-full border rounded-lg px-3 py-2"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Categor√≠a</label>
                    <select id="productCategory" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="bebidas">Bebidas</option>
                        <option value="comida">Comida</option>
                        <option value="postres">Postres</option>
                        <option value="golosinas">Golosinas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Stock de Producto Final</label>
                    <input type="number" id="productStock" class="w-full border rounded-lg px-3 py-2" required>
                </div>

                <div id="productRecipeSection" class="border-t pt-4">
                    <h4 class="font-bold mb-2 text-md text-blue-700">Receta (Materia Prima por 1 unidad)</h4>
                    <div id="productMaterialsContainer" class="space-y-2 border p-3 rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500">Haz clic en "A√±adir Materia Prima" para empezar.</p>
                    </div>
                    <button type="button" onclick="addMaterialFieldToProductModal()"
                        class="w-full mt-2 py-2 px-4 bg-indigo-500 text-white rounded-lg font-medium hover:bg-indigo-600 transition-colors text-sm">
                        + A√±adir Materia Prima
                    </button>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="supplierProductModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up max-h-[90vh] overflow-y-auto">
            <h3 id="supplierModalTitle" class="text-lg font-bold mb-4">Agregar Producto de Proveedor</h3>
            <form id="supplierProductForm" class="space-y-4">
                <input type="hidden" id="supplierProductId">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre</label>
                    <input type="text" id="supplierProductName" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Emoji (Ej: ü•§, üçü)</label>
                    <input type="text" id="supplierProductEmoji" class="w-full border rounded-lg px-3 py-2"
                        maxlength="2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                    <textarea id="supplierProductDescription"
                        class="w-full border rounded-lg px-3 py-2 resize-none h-16"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Imagen de Vista Previa (URL)</label>
                    <input type="url" id="supplierProductImageURL"
                        class="w-full border rounded-lg px-3 py-2 mb-2 text-gray-800"
                        placeholder="Opcional: Enlace URL a la imagen">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Precio de Venta</label>
                        <input type="number" id="supplierProductPrice" step="0.01"
                            class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Stock Disponible</label>
                        <input type="number" id="supplierProductStock" class="w-full border rounded-lg px-3 py-2"
                            required>
                    </div>
                </div>

                <input type="hidden" id="supplierProductCategory" value="golosinas">

                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeSupplierProductModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-medium">
                        Guardar Producto
                    </button>
                </div>
            </form>
            <div id="supplierProductDeleteContainer" class="mt-4 hidden">
                <button type="button"
                    onclick="deleteSupplierProduct(parseInt(document.getElementById('supplierProductId').value))"
                    class="w-full bg-red-500 text-white py-2 rounded-lg font-medium hover:bg-red-600">
                    Eliminar Producto de Proveedor
                </button>
            </div>
        </div>
    </div>
    <div id="rawMaterialModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up">
            <h3 id="materialModalTitle" class="text-lg font-bold mb-4">Editar Materia Prima</h3>
            <form id="rawMaterialForm" class="space-y-4">
                <input type="hidden" id="materialId">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre</label>
                    <input type="text" id="materialName" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Emoji (Ej: ‚òï, üçö)</label>
                    <input type="text" id="materialEmoji" class="w-full border rounded-lg px-3 py-2" maxlength="2"
                        required>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Stock Actual</label>
                        <input type="number" id="materialStock" step="0.01" class="w-full border rounded-lg px-3 py-2"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Unidad (Ej: kg, L, pzas)</label>
                        <input type="text" id="materialUnit" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeRawMaterialModal()
                        " class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">
                        Guardar
                    </button>
                </div>
            </form>
            <div id="materialDeleteContainer" class="mt-4 hidden">
                <button type="button" onclick="deleteRawMaterial(parseInt(document.getElementById('materialId').value))"
                    class="w-full bg-red-500 text-white py-2 rounded-lg font-medium hover:bg-red-600">
                    Eliminar Materia Prima
                </button>
            </div>
        </div>
    </div>

    <div id="supplierPurchaseModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up">
            <h3 id="purchaseModalTitle" class="text-lg font-bold mb-4">Registrar Compra</h3>
            <form id="supplierPurchaseForm" class="space-y-4">
                <input type="hidden" id="purchaseId">
                <div>
                    <label class="block text-sm font-medium mb-1">Materia Prima</label>
                    <select id="purchaseMaterialId" class="w-full border rounded-lg px-3 py-2" required>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad Comprada</label>
                        <input type="number" id="purchaseQuantity" step="0.01"
                            class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Unidad</label>
                        <input type="text" id="purchaseUnit" class="w-full border rounded-lg px-3 py-2 bg-gray-100"
                            readonly>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Costo Total ($)</label>
                    <input type="number" id="purchaseCost" step="0.01" class="w-full border rounded-lg px-3 py-2"
                        placeholder="Ej: 550.50" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre del Proveedor (Opcional)</label>
                    <input type="text" id="supplierName" class="w-full border rounded-lg px-3 py-2"
                        placeholder="Ej: Proveedora del Sur">
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closePurchaseModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- =================== MODAL: FORMULARIO DE FACTURA CFDI (SIMULADA) =================== -->
    <div id="invoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-3 text-blue-700">Generar Factura CFDI (Simulada)</h3>

            <form id="invoiceForm" class="space-y-3">
                <input type="hidden" id="invoiceOrderId">

                <!-- Resumen del pedido -->
                <div class="text-xs bg-gray-50 border rounded-lg p-3 mb-2">
                    <p><span class="font-semibold">Pedido: </span><span id="invoiceOrderInfo"></span></p>
                    <p><span class="font-semibold">Cliente: </span><span id="invoiceOrderClient"></span></p>
                    <p><span class="font-semibold">Total: </span><span id="invoiceOrderTotal"></span></p>
                </div>

                <!-- Emisor (fijo / simulado) -->
                <div class="border rounded-lg p-3 bg-blue-50">
                    <p class="text-xs font-semibold text-blue-800 mb-1">Emisor (Cafeter√≠a)</p>
                    <p class="text-xs">Nombre: <span class="font-semibold">CAFE-TEC S.A. de C.V.</span></p>
                    <p class="text-xs">RFC: <span class="font-semibold">CACX7605101P8</span></p>
                    <p class="text-xs">R√©gimen: <span class="font-semibold">601 - General de Ley Personas Morales</span>
                    </p>
                    <p class="text-xs">CP: <span class="font-semibold">30000</span></p>
                </div>

                <!-- Receptor -->
                <div class="border rounded-lg p-3 space-y-2">
                    <p class="text-xs font-semibold text-gray-700 mb-1">Datos del Receptor</p>

                    <div>
                        <label class="block text-xs font-medium mb-1">RFC Receptor</label>
                        <input type="text" id="invoiceRfc" class="w-full border rounded-lg px-3 py-2 text-xs uppercase"
                            placeholder="XAXX010101000" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Raz√≥n Social / Nombre</label>
                        <input type="text" id="invoiceRazon" class="w-full border rounded-lg px-3 py-2 text-xs"
                            placeholder="Nombre del cliente" required>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium mb-1">CP Receptor</label>
                            <input type="text" id="invoiceCp" class="w-full border rounded-lg px-3 py-2 text-xs"
                                placeholder="30000" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">R√©gimen Fiscal Receptor</label>
                            <input type="text" id="invoiceRegimenReceptor"
                                class="w-full border rounded-lg px-3 py-2 text-xs"
                                placeholder="605 - Sueldos y salarios">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Uso CFDI</label>
                        <select id="invoiceUsoCfdi" class="w-full border rounded-lg px-3 py-2 text-xs" required>
                            <option value="G01">G01 - Adquisici√≥n de mercanc√≠as</option>
                            <option value="G03" selected>G03 - Gastos en general</option>
                            <option value="P01">P01 - Por definir</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Correo del Receptor (opcional)</label>
                        <input type="email" id="invoiceEmail" class="w-full border rounded-lg px-3 py-2 text-xs"
                            placeholder="cliente@ejemplo.com">
                    </div>
                </div>

                <!-- Pago -->
                <div class="border rounded-lg p-3 space-y-2">
                    <p class="text-xs font-semibold text-gray-700 mb-1">Datos de Pago</p>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium mb-1">M√©todo de Pago (SAT)</label>
                            <select id="invoiceMetodoPago" class="w-full border rounded-lg px-3 py-2 text-xs" required>
                                <option value="PUE" selected>PUE - Pago en una sola exhibici√≥n</option>
                                <option value="PPD">PPD - Pago en parcialidades o diferido</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Forma de Pago (SAT)</label>
                            <select id="invoiceFormaPago" class="w-full border rounded-lg px-3 py-2 text-xs" required>
                                <option value="01">01 - Efectivo</option>
                                <option value="03">03 - Transferencia electr√≥nica</option>
                                <option value="04">04 - Tarjeta de cr√©dito</option>
                                <option value="28">28 - Tarjeta de d√©bito</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3 pt-2">
                    <button type="button" onclick="closeInvoiceModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg text-sm font-medium">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">
                        Guardar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- =================== MODAL: TICKET DE FACTURA CFDI =================== -->
    <div id="invoiceTicketModal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up shadow-xl font-mono text-xs">
            <div class="text-center mb-2">
                <h4 class="font-bold text-base">CAFE-TEC</h4>
                <p class="text-[0.65rem]">RFC: <span id="invoiceTicketEmisorRfc"></span></p>
                <p class="text-[0.65rem]">TecNM campus Comit√°n</p>
                <p class="text-[0.65rem] mt-1 font-semibold">FACTURA CFDI (SIMULADA)</p>
            </div>

            <div class="flex justify-between text-[0.65rem] mb-2">
                <div>
                    <p>Folio: <span id="invoiceTicketFolio"></span></p>
                    <p class="break-all">UUID: <span id="invoiceTicketUuid"></span></p>
                </div>
                <div class="text-right">
                    <p>Fecha: <span id="invoiceTicketDate"></span></p>
                    <p>M√©todo: <span id="invoiceTicketMetodo"></span></p>
                    <p>Forma: <span id="invoiceTicketForma"></span></p>
                </div>
            </div>

            <div class="ticket-line" style="border-top: 1px dashed #9ca3af; margin: 6px 0;"></div>

            <div class="text-[0.65rem] mb-2">
                <p class="font-semibold">Receptor</p>
                <p>RFC: <span id="invoiceTicketReceptorRfc"></span></p>
                <p>Nombre: <span id="invoiceTicketReceptorNombre"></span></p>
                <p>Uso CFDI: <span id="invoiceTicketUsoCfdi"></span></p>
                <p>R√©gimen: <span id="invoiceTicketRegimenReceptor"></span></p>
                <p>CP: <span id="invoiceTicketCpReceptor"></span></p>
            </div>

            <div class="ticket-line" style="border-top: 1px dashed #9ca3af; margin: 6px 0;"></div>

            <table class="w-full text-[0.65rem]">
                <thead>
                    <tr>
                        <th class="text-left font-semibold">Cant.</th>
                        <th class="text-left font-semibold">Concepto</th>
                        <th class="text-right font-semibold">Importe</th>
                    </tr>
                </thead>
                <tbody id="invoiceTicketItems"></tbody>
            </table>

            <div class="ticket-line" style="border-top: 1px dashed #9ca3af; margin: 6px 0;"></div>

            <div class="text-[0.7rem] space-y-1">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span id="invoiceTicketSubtotal"></span>
                </div>
                <div class="flex justify-between">
                    <span>IVA 16%:</span>
                    <span id="invoiceTicketIva"></span>
                </div>
                <div class="flex justify-between font-bold text-sm">
                    <span>TOTAL:</span>
                    <span id="invoiceTicketTotal"></span>
                </div>
            </div>

            <button onclick="closeInvoiceTicketModal()"
                class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 mt-4">
                Cerrar
            </button>
        </div>
    </div>

    <div id="productPreviewModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50">
        <div class="bg-white rounded-t-3xl w-full max-w-md slide-up max-h-[90vh] overflow-y-auto">

            <div id="previewImageContainer" class="relative h-64 w-full bg-preview rounded-t-3xl"
                style="background-image: url('https://images.unsplash.com/photo-1541167760496-1628856ab22d?q=80&w=2047&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D')">
                <button onclick="closeProductPreview()"
                    class="absolute top-4 left-4 p-2 bg-white bg-opacity-80 rounded-full shadow-lg z-10 hover:bg-opacity-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <h2 id="previewProductName" class="text-3xl font-bold mb-2">Nombre del Producto</h2>
                <p id="previewProductDescription" class="text-gray-600 mb-4">Descripci√≥n breve.</p>

                <div class="flex space-x-6 text-center text-sm mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1" id="previewTimeContainer">
                        <span class="block text-amber-500 text-lg">üïí</span>
                        <span id="previewTime" class="block font-medium">1 min</span>
                        <span class="text-xs text-gray-500">Preparaci√≥n</span>
                    </div>
                    <div class="flex-1">
                        <span class="block text-red-500 text-lg">üî•</span>
                        <span id="previewCalories" class="block font-medium">100 Cal</span>
                        <span class="text-xs text-gray-500">Energ√≠a</span>
                    </div>
                    <div class="flex-1">
                        <span class="block text-blue-500 text-lg">üßë‚Äçüç≥</span>
                        <span id="previewStock" class="block font-medium">0 disp.</span>
                        <span class="text-xs text-gray-500">Stock</span>
                    </div>
                </div>
                <h3 class="text-xl font-bold mb-4">üõí Opciones de Pedido</h3>

                <div class="flex items-center justify-between border-t pt-4">
                    <span class="text-2xl font-bold text-green-600" id="previewProductPrice">$0.00</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="updatePreviewQuantity(-1)"
                            class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center font-bold text-lg">-</button>
                        <span class="w-10 text-center text-xl font-semibold" id="previewQuantity">1</span>
                        <button onclick="updatePreviewQuantity(1)"
                            class="w-10 h-10 bg-amber-600 text-white rounded-full flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                </div>
                <button onclick="addToCartFromPreview()" id="previewAddToCartButton"
                    class="w-full mt-4 bg-green-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-green-700 transition-colors">
                    Agregar al Carrito
                </button>
            </div>
        </div>
    </div>

    <div id="passwordResetModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up">
            <h3 class="text-xl font-bold mb-4 text-blue-700">üîë Restablecer Contrase√±a</h3>
            <form id="passwordResetForm" class="space-y-4">
                <p class="text-sm text-gray-600">Ingresa tus datos de verificaci√≥n para establecer una nueva contrase√±a.
                </p>
                <div>
                    <label class="block text-sm font-medium mb-1">Usuario, No. Control o Tel√©fono</label>
                    <input type="text" id="resetUser" class="w-full border rounded-lg px-3 py-2 text-gray-800"
                        placeholder="Usuario, No. Control o Tel√©fono" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Tel√©fono Registrado</label>
                    <input type="tel" id="resetPhone" class="w-full border rounded-lg px-3 py-2 text-gray-800"
                        placeholder="N√∫mero de Tel√©fono (sin guiones)" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Nueva Contrase√±a</label>
                    <div class="relative">
                        <input type="password" id="resetNewPassword"
                            class="w-full border rounded-lg pl-3 pr-10 py-2 text-gray-800" required>
                        <button type="button" onclick="togglePasswordVisibility('resetNewPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                            <svg class="h-5 w-5 hidden" id="eye-icon-resetNewPassword" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg class="h-5 w-5" id="eye-slash-icon-resetNewPassword" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Confirmar Nueva Contrase√±a</label>
                    <div class="relative">
                        <input type="password" id="resetConfirmPassword"
                            class="w-full border rounded-lg pl-3 pr-10 py-2 text-gray-800" required>
                        <button type="button" onclick="togglePasswordVisibility('resetConfirmPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                            <svg class="h-5 w-5 hidden" id="eye-icon-resetConfirmPassword" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg class="h-5 w-5" id="eye-slash-icon-resetConfirmPassword" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex space-x-3 pt-2">
                    <button type="button" onclick="closePasswordResetModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">
                        Restablecer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Editar Datos Personales</h3>
            <form id="editUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label class="block text-sm font-medium mb-1">Tipo de Usuario</label>
                    <select id="editUserType" class="w-full border rounded-lg px-3 py-2"
                        onchange="toggleEditUserFields()" required>
                        <option value="estudiante">üë®‚Äçüéì Estudiante</option>
                        <option value="docente">üë©‚Äçüè´ Docente</option>
                        <option value="administrativo">üë®‚Äçüíº Administrativo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre Completo</label>
                    <input type="text" id="editFullName" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre de Usuario (√önico)</label>
                    <input type="text" id="editUsername" class="w-full border rounded-lg px-3 py-2" required>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Tecnol√≥gico</label>
                    <input type="text" id="editTecnologico" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div id="editStudentFields" class="hidden space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">N√∫mero de Control</label>
                        <input type="text" id="editControlNumber" class="w-full border rounded-lg px-3 py-2"
                            placeholder="Ej: 20230001">
                    </div>


                    <div>
                        <label class="block text-sm font-medium mb-1">Carrera</label>
                        <select id="editCareer" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Seleccionar carrera</option>
                            <option value="Ingenier√≠a en Sistemas Computacionales">Ingenier√≠a en Sistemas
                                Computacionales</option>
                            <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                            <option value="Ingenier√≠a Electr√≥nica">Ingenier√≠a Electr√≥nica</option>
                            <option value="Ingenier√≠a Mec√°nica">Ingenier√≠a Mec√°nica</option>
                            <option value="Ingenier√≠a Civil">Ingenier√≠a Civil</option>
                            <option value="Licenciatura en Administraci√≥n">Licenciatura en Administraci√≥n</option>
                            <option value="Contador P√∫blico">Contador P√∫blico</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Semestre</label>
                            <select id="editSemester" class="w-full border rounded-lg px-3 py-2">
                                <option value="">Seleccionar</option>
                                <option value="1">1¬∞</option>
                                <option value="2">2¬∞</option>
                                <option value="3">3¬∞</option>
                                <option value="4">4¬∞</option>
                                <option value="5">5¬∞</option>
                                <option value="6">6¬∞</option>
                                <option value="7">7¬∞</option>
                                <option value="8">8¬∞</option>
                                <option value="9">9¬∞</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Grupo</label>
                            <select id="editGroup" class="w-full border rounded-lg px-3 py-2">
                                <option value="">Seleccionar</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="editStaffFields" class="hidden space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">N√∫mero de Tel√©fono</label>
                        <input type="tel" id="editPhoneNumber" class="w-full border rounded-lg px-3 py-2"
                            placeholder="Ej: 5551234567">
                    </div>
                </div>

                <div class="border-t pt-3">
                    <label class="block text-sm font-semibold mb-1">Periodo de Actividad de la Cuenta</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium mb-1">Activa Desde (Registro)</label>
                            <input type="datetime-local" id="editRegistrationDate"
                                class="w-full border rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Activa Hasta</label>
                            <input type="datetime-local" id="editAccountActiveUntil"
                                class="w-full border rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                </div>
                <div class="border-t pt-3">
                    <label class="block text-sm font-semibold mb-1">Cambiar Contrase√±a (opcional)</label>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="relative">
                            <input type="password" id="editNewPassword" class="w-full border rounded-lg pl-3 pr-10 py-2"
                                placeholder="Nueva contrase√±a">
                            <button type="button" onclick="togglePasswordVisibility('editNewPassword')"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                                <svg class="h-5 w-5 hidden" id="eye-icon-editNewPassword" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg class="h-5 w-5" id="eye-slash-icon-editNewPassword" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2 2l20 20" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative">
                            <input type="password" id="editConfirmPassword"
                                class="w-full border rounded-lg pl-3 pr-10 py-2"
                                placeholder="Confirmar nueva contrase√±a">
                            <button type="button" onclick="togglePasswordVisibility('editConfirmPassword')"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
                                <svg class="h-5 w-5 hidden" id="eye-icon-editConfirmPassword" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.022 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg class="h-5 w-5" id="eye-slash-icon-editConfirmPassword" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.875 18.825A10.05 10.05 0 0112 20c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 015.353-6.467M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2 2l20 20" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button type="button" onclick="closeEditUserModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderConfirmationModal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 m-4 w-full max-w-sm slide-up shadow-xl">
            <div class="text-center">
                <div class="w-16 h-16 rounded-full bg-green-100 p-3 flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold mb-2 text-gray-800">¬°Pedido Confirmado!</h3>
                <p class="text-gray-600 mb-6">Tu pedido ha sido recibido y se est√° preparando.</p>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 font-mono text-sm">
                <div class="text-center mb-3">
                    <h4 class="font-bold text-lg">CAFE-TEC</h4>
                    <p class="text-xs">TecNM campus Comit√°n</p>
                    <p class="text-xs">TICKET DE COMPRA</p>
                </div>

                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span>Referencia:</span>
                        <strong id="ticket-ref">CT12345</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Cliente:</span>
                        <strong id="ticket-user" class="truncate max-w-[150px]">Nombre Cliente</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Recoger:</span>
                        <strong id="ticket-time">10:30 AM</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Pagado con:</span>
                        <strong id="ticket-payment" class="capitalize">Efectivo</strong>
                    </div>
                </div>

                <div class="ticket-line" style="border-top: 1px dashed #9ca3af; margin: 12px 0;"></div>

                <table class="w-full">
                    <thead>
                        <tr>
                            <th class="text-left font-semibold">Cant.</th>
                            <th class="text-left font-semibold">Producto</th>
                            <th class="text-right font-semibold">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="ticket-items">
                        <tr>
                            <td class="pr-2">1x</td>
                            <td>Caf√© Americano</td>
                            <td class="text-right">$25.00</td>
                        </tr>
                    </tbody>
                </table>

                <div class="ticket-line" style="border-top: 1px dashed #9ca3af; margin: 12px 0;"></div>

                <div class="flex justify-between font-bold text-lg">
                    <span>TOTAL:</span>
                    <span id="ticket-total">$25.00</span>
                </div>
            </div>

            <button onclick="closeConfirmationModal()"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors mt-6">
                Aceptar
            </button>
        </div>
    </div>
</body>

</html>
<script>
    // ====================================================================================
    // G E S T I √ì N¬† D E¬† M E M O R I A¬† L O C A L
    // ====================================================================================

    const STORAGE_KEYS = {
        PRODUCTS: 'cafetec_products',
        MATERIALS: 'cafetec_materials',
        SUPPLIER_PURCHASES: 'cafetec_supplier_purchases',
        ORDERS: 'cafetec_orders',
        USERS: 'cafetec_users',
        CURRENT_USER: 'cafetec_current_user',
        ORDER_ID_COUNTER: 'cafetec_order_id_counter'
    };

    function saveState() {
        localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
        localStorage.setItem(STORAGE_KEYS.MATERIALS, JSON.stringify(rawMaterials));
        localStorage.setItem(STORAGE_KEYS.SUPPLIER_PURCHASES, JSON.stringify(supplierPurchases));
        localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
        localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
        localStorage.setItem(STORAGE_KEYS.ORDER_ID_COUNTER, orderIdCounter);
    }

    function loadState() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const storedProducts = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
        const storedMaterials = localStorage.getItem(STORAGE_KEYS.MATERIALS);
        const storedPurchases = localStorage.getItem(STORAGE_KEYS.SUPPLIER_PURCHASES);
        const storedOrders = localStorage.getItem(STORAGE_KEYS.ORDERS);
        const storedUsers = localStorage.getItem(STORAGE_KEYS.USERS);
        const storedCurrentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
        const storedOrderIdCounter = localStorage.getItem(STORAGE_KEYS.ORDER_ID_COUNTER);

        if (storedProducts) products = JSON.parse(storedProducts);
        if (storedMaterials) rawMaterials = JSON.parse(storedMaterials);
        if (storedPurchases) supplierPurchases = JSON.parse(storedPurchases);
        if (storedOrders) orders = JSON.parse(storedOrders);

        if (storedUsers) {
            users = JSON.parse(storedUsers).map(u => {
                const registrationDate = u.registrationDate ? new Date(u.registrationDate) : new Date(0);
                let accountActiveUntil = u.accountActiveUntil ? new Date(u.accountActiveUntil) : null;

                if (!accountActiveUntil && u.registrationDate) {
                    accountActiveUntil = new Date(registrationDate.getTime() + 24 * 60 * 60 * 1000);
                }

                // NUEVO: valor por defecto de estado de cuenta (activa)
                const isActive = (typeof u.isActive === 'boolean') ? u.isActive : true;

                return {
                    ...u,
                    isActive,
                    registrationDate,
                    accountActiveUntil
                };
            });
        }
        if (storedCurrentUser) currentUser = JSON.parse(storedCurrentUser);
        if (storedOrderIdCounter) orderIdCounter = parseInt(storedOrderIdCounter);

        // Si hay sesi√≥n previa, validar estado de cuenta/expiraci√≥n antes de entrar directo
        if (currentUser) {
            if (currentUser.userType === 'admin') {
                showAdminPanel();
            } else {
                // buscar al usuario real por id
                const cu = users.find(u => u.id === currentUser.id);
                const now = new Date();
                if (!cu) {
                    currentUser = null;
                    saveState();
                    showLogin();
                    setLoginMessage('üö´ Tu usuario ya no existe. Contacta al administrador.', 'error');
                    return;
                }
                if (cu.isActive === false) {
                    currentUser = null;
                    saveState();
                    showLogin();
                    setLoginMessage('üö´ Cuenta desactivada. Contacta al administrador.', 'error');
                    return;
                }
                if (cu.accountActiveUntil && now.getTime() > new Date(cu.accountActiveUntil).getTime()) {
                    currentUser = null;
                    saveState();
                    showLogin();
                    setLoginMessage('üö´ Acceso bloqueado: tu cuenta ha expirado. Contacta al administrador.', 'error');
                    return;
                }

                document.getElementById('welcomeUserName').textContent = cu.fullName;
                showWelcome();
            }
        } else {
            showLogin();
        }
    }

    // ====================================================================================
    // E S T A D O S¬† I N I C I A L E S¬†
    // ====================================================================================

    let rawMaterials = [
        // ... (Esta secci√≥n se mantiene igual que la original) ...
        { id: 101, name: 'Granos de Caf√©', stock: 5.0, unit: 'kg', emoji: '‚òï' },
        { id: 102, name: 'Leche', stock: 20.0, unit: 'L', emoji: 'ü•õ' },
        { id: 103, name: 'Az√∫car', stock: 15.0, unit: 'kg', emoji: 'üçö' },
        { id: 104, name: 'Pan Club', stock: 30.0, unit: 'pzas', emoji: 'üçû' },
        { id: 105, name: 'Pollo', stock: 10.0, unit: 'kg', emoji: 'üçó' },
        { id: 106, name: 'Lechuga', stock: 8.0, unit: 'kg', emoji: 'ü•¨' },
        { id: 107, name: 'Aderezo C√©sar', stock: 5.0, unit: 'L', emoji: 'üß¥' },
        { id: 108, name: 'Queso Crema', stock: 12.0, unit: 'kg', emoji: 'üßÄ' },
        { id: 109, name: 'Chocolate', stock: 18.0, unit: 'kg', emoji: 'üç´' }
    ];

    let products = [
        // Productos hechos en casa (manufactured)
        {
            id: 1, name: 'Caf√© Americano', price: 25.00, category: 'bebidas', stock: 50, emoji: '‚òï',
            materialsNeeded: [
                { materialId: 101, quantity: 0.02 },
                { materialId: 103, quantity: 0.01 }
            ],
            isSupplierProduct: false,
            imageURL: 'https://images.unsplash.com/photo-1509785116905-f370a1a0fb84?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'El cl√°sico caf√©, simple y arom√°tico. Perfecto para iniciar la ma√±ana o recargar energ√≠as.',
            time: '2 min', calories: '5 Cal'
        },
        {
            id: 2, name: 'Cappuccino', price: 35.00, category: 'bebidas', stock: 30, emoji: '‚òï',
            materialsNeeded: [
                { materialId: 101, quantity: 0.015 },
                { materialId: 102, quantity: 0.2 }
            ],
            isSupplierProduct: false,
            imageURL: 'https://images.unsplash.com/photo-1517454238596-f947477610c4?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'Espresso con leche espumada, suave y cremoso. Una delicia para los amantes del caf√© con leche.',
            time: '5 min', calories: '120 Cal'
        },
        {
            id: 3, name: 'Sandwich Club', price: 65.00, category: 'comida', stock: 20, emoji: 'ü•™',
            materialsNeeded: [
                { materialId: 104, quantity: 3 },
                { materialId: 105, quantity: 0.1 },
                { materialId: 106, quantity: 0.05 }
            ],
            isSupplierProduct: false,
            imageURL: 'https://images.unsplash.com/photo-1627915570889-019688b13958?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'Cl√°sico s√°ndwich de pollo, jam√≥n, queso y verduras en triple pan tostado.',
            time: '10 min', calories: '350 Cal'
        },
        {
            id: 4, name: 'Ensalada C√©sar', price: 55.00, category: 'comida', stock: 15, emoji: 'ü•ó',
            materialsNeeded: [
                { materialId: 106, quantity: 0.15 },
                { materialId: 107, quantity: 0.05 },
                { materialId: 105, quantity: 0.05 }
            ],
            isSupplierProduct: false,
            imageURL: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'La ensalada m√°s famosa: lechuga, crutones, queso parmesano y aderezo C√©sar.',
            time: '8 min', calories: '230 Cal'
        },
        {
            id: 5, name: 'Cheesecake', price: 45.00, category: 'postres', stock: 12, emoji: 'üç∞',
            materialsNeeded: [
                { materialId: 108, quantity: 0.2 },
                { materialId: 103, quantity: 0.05 }
            ],
            isSupplierProduct: false,
            imageURL: 'https://images.unsplash.com/photo-1565292881729-e85d9c228220?q=80&w=1925&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'Tarta de queso cremosa con base de galleta, servida con coulis de frutos rojos.',
            time: '5 min', calories: '480 Cal'
        },
        {
            id: 6, name: 'Muffin Chocolate', price: 30.00, category: 'postres', stock: 25, emoji: 'üßÅ',
            materialsNeeded: [
                { materialId: 109, quantity: 0.1 },
                { materialId: 103, quantity: 0.02 }
            ],
            isSupplierProduct: false,
            imageURL: 'https://images.unsplash.com/photo-1628172088031-155e97148530?q=80&w=2071&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'Suave panecillo de chocolate, ideal para acompa√±ar tu caf√© o como postre r√°pido.',
            time: '3 min', calories: '290 Cal'
        },
        // START: PRODUCTOS DE PROVEEDOR POR DEFECTO
        {
            id: 7, name: 'Refresco Coca-Cola', price: 22.00, category: 'golosinas', stock: 40, emoji: 'ü•§',
            materialsNeeded: [], // No tiene receta, es producto final de proveedor
            isSupplierProduct: true,
            imageURL: 'https://images.unsplash.com/photo-1625902403780-fd4da67c9c0f?q=80&w=1920&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'Refresco embotellado de 600ml.',
            time: '0 min', calories: '250 Cal'
        },
        {
            id: 8, name: 'Papas Fritas Queso', price: 18.00, category: 'golosinas', stock: 55, emoji: 'üßÄ',
            materialsNeeded: [],
            isSupplierProduct: true,
            imageURL: 'https://images.unsplash.com/photo-1596701830601-e94119d54e0b?q=80&w=1920&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            description: 'Bolsa de papas fritas sabor queso, marca comercial.',
            time: '0 min', calories: '180 Cal'
        },
        // END: PRODUCTOS DE PROVEEDOR POR DEFECTO
    ];

    let cart = [];
    let currentCategory = 'all';
    let orders = [];
    let supplierPurchases = [];
    let orderIdCounter = 1;
    let users = [];
    let currentUser = null;
    let previewProduct = null;
    let currentAdminProductType = 'manufactured'; // Nuevo estado para la sub-pesta√±a

    if (!localStorage.getItem(STORAGE_KEYS.PRODUCTS)) {
        localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
        localStorage.setItem(STORAGE_KEYS.MATERIALS, JSON.stringify(rawMaterials));
        localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
        localStorage.setItem(STORAGE_KEYS.SUPPLIER_PURCHASES, JSON.stringify(supplierPurchases));
        localStorage.setItem(STORAGE_KEYS.ORDER_ID_COUNTER, orderIdCounter);
    }

    // ====================================================================================
    // F U N C I O N E S¬† D E¬† A U T E N T I C A C I √ì N (Sin cambios funcionales, solo se mantienen)
    // ====================================================================================

    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(`eye-icon-${inputId}`);
        const eyeSlashIcon = document.getElementById(`eye-slash-icon-${inputId}`);

        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.classList.remove('hidden');
            eyeSlashIcon.classList.add('hidden');
        } else {
            input.type = 'password';
            eyeIcon.classList.add('hidden');
            eyeSlashIcon.classList.remove('hidden');
        }
    }

    function setLoginMessage(msg, type = 'error') {
        const el = document.getElementById('loginMessage');
        if (!el) return;
        el.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');
        if (type === 'success') {
            el.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'warning') {
            el.classList.add('bg-yellow-100', 'text-yellow-800');
        } else {
            el.classList.add('bg-red-100', 'text-red-800');
        }
        el.textContent = msg;
    }

    function clearLoginMessage() {
        const el = document.getElementById('loginMessage');
        if (el) el.classList.add('hidden');
    }

    function clearLoginFields() {
        document.getElementById('loginUser').value = '';
        document.getElementById('loginPassword').value = '';
        clearLoginMessage();
    }

    function showPasswordResetModal() {
        document.getElementById('passwordResetModal').classList.remove('hidden');
    }

    function closePasswordResetModal() {
        document.getElementById('passwordResetModal').classList.add('hidden');
        document.getElementById('passwordResetForm').reset();
    }

    document.getElementById('passwordResetForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const loginIdentifier = document.getElementById('resetUser').value.trim();
        const phone = document.getElementById('resetPhone').value.trim();
        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;

        if (newPassword !== confirmPassword) {
            setLoginMessage('Las nuevas contrase√±as no coinciden.', 'error');
            return;
        }

        let user = users.find(u =>
            u.username === loginIdentifier ||
            u.controlNumber === loginIdentifier ||
            u.phoneNumber === loginIdentifier
        );

        if (user) {
            const isPhoneMatch = (user.phoneNumber && user.phoneNumber === phone) || (user.userType === 'estudiante' && user.controlNumber && user.controlNumber === phone);

            if (isPhoneMatch) {
                user.password = newPassword;
                setLoginMessage(`Contrase√±a restablecida para ${user.fullName}. Por favor inicia sesi√≥n.`, 'success');
                saveState();
                closePasswordResetModal();
                showLogin();
                return;
            }
        }
        setLoginMessage('Error: Los datos de verificaci√≥n no coinciden. Int√©ntalo de nuevo.', 'error');
        closePasswordResetModal();
    });

    function showLogin() {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('registerScreen').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('customerMenu').classList.add('hidden');
        document.getElementById('cartScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
        document.getElementById('productPreviewModal').classList.add('hidden');
        document.getElementById('passwordResetModal').classList.add('hidden');
    }

    function showRegister() {
        document.getElementById('registerScreen').classList.remove('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('productPreviewModal').classList.add('hidden');
        document.getElementById('passwordResetModal').classList.add('hidden');
    }

    function toggleUserFields() {
        const userType = document.getElementById('userType').value;
        const studentFields = document.getElementById('studentFields');
        const staffFields = document.getElementById('staffFields');

        if (userType === 'estudiante') {
            studentFields.classList.remove('hidden');
            staffFields.classList.add('hidden');
            document.getElementById('controlNumber').required = true;
            document.getElementById('career').required = true;
            document.getElementById('semester').required = true;
            document.getElementById('group').required = true;
            document.getElementById('phoneNumber').required = false;
        } else if (['profesor', 'docente', 'administrativo'].includes(userType)) {
            studentFields.classList.add('hidden');
            staffFields.classList.remove('hidden');
            document.getElementById('phoneNumber').required = true;
            document.getElementById('controlNumber').required = false;
            document.getElementById('career').required = false;
            document.getElementById('semester').required = false;
            document.getElementById('group').required = false;
        } else {
            studentFields.classList.add('hidden');
            staffFields.classList.add('hidden');
        }
    }

    function previewCredential() {
        const file = document.getElementById('credentialFile').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('credentialImage').src = e.target.result;
                document.getElementById('credentialPreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    document.getElementById('registerForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const userType = document.getElementById('userType').value;
        const fullName = document.getElementById('fullName').value;
        // =========== OBTENER VALOR DEL NUEVO CAMPO ===========
        const tecnologico = document.getElementById('tecnologico').value.trim();
        // =====================================================
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (password !== confirmPassword) {
            setLoginMessage('Las contrase√±as no coinciden.', 'error');
            return;
        }

        if (users.some(user => user.username && user.username.toLowerCase() === username.toLowerCase())) {
            setLoginMessage('Este nombre de usuario ya est√° registrado. Por favor, elige otro.', 'error');
            return;
        }

        const now = new Date();
        const newUser = {
            id: users.length + 1,
            userType: userType,
            fullName: fullName,
            tecnologico: tecnologico, // <-- NUEVO DATO GUARDADO
            username: username,
            password: password,
            registrationDate: now,
            isActive: true // NUEVO: por defecto activa
        };

        if (userType === 'estudiante') {
            const controlNumber = document.getElementById('controlNumber').value.trim();

            if (users.some(user => user.controlNumber === controlNumber && user.controlNumber)) {
                setLoginMessage('Este n√∫mero de control ya est√° registrado.', 'error');
                return;
            }

            newUser.controlNumber = controlNumber;
            newUser.career = document.getElementById('career').value;
            newUser.semester = document.getElementById('semester').value;
            newUser.group = document.getElementById('group').value;

        } else {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (users.some(user => user.phoneNumber === phoneNumber && user.phoneNumber)) {
                setLoginMessage('Este n√∫mero de tel√©fono ya est√° registrado.', 'error');
                return;
            }

            newUser.phoneNumber = phoneNumber;
        }

        const credentialFile = document.getElementById('credentialFile').files[0];
        if (credentialFile) {
            newUser.hasCredential = true;
            newUser.credentialName = credentialFile.name;
        }

        users.push(newUser);

        setLoginMessage(`¬°Registro exitoso! Ya puedes iniciar sesi√≥n con tu usuario: ${username}.`, 'success');

        document.getElementById('registerForm').reset();
        document.getElementById('credentialPreview').classList.add('hidden');
        toggleUserFields();
        saveState();
        showLogin();
    });

    function login() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        clearLoginMessage();

        const loginIdentifier = document.getElementById('loginUser').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!loginIdentifier || !password) {
            setLoginMessage('Por favor ingresa tu identificador y contrase√±a', 'warning');
            return;
        }

        if (loginIdentifier.toUpperCase() === 'ADMIN' && password === 'ADMIN') {
            currentUser = { id: 0, userType: 'admin', fullName: 'Administrador', username: 'ADMIN' };
            saveState();
            showAdminPanel();
            return;
        }

        const user = users.find(u =>
            (u.username && u.username.toLowerCase() === loginIdentifier.toLowerCase() && u.password === password) ||
            (u.controlNumber && u.controlNumber === loginIdentifier && u.password === password) ||
            (u.phoneNumber && u.phoneNumber === loginIdentifier && u.password === password)
        );

        if (user) {
            // NUEVO: bloqueo si est√° desactivada
            if (user.isActive === false) {
                setLoginMessage('üö´ Cuenta desactivada. Contacta al administrador.', 'error');
                return;
            }

            const registrationDate = user.registrationDate instanceof Date ? user.registrationDate : new Date(user.registrationDate);
            const currentDate = new Date();
            const accountActiveUntil = user.accountActiveUntil instanceof Date ? user.accountActiveUntil : new Date(user.accountActiveUntil);

            if (currentDate.getTime() < registrationDate.getTime()) {
                setLoginMessage(`üö´ Acceso Bloqueado: La fecha de tu computadora es anterior a tu registro. Por favor, actualiza la fecha para continuar.`, 'error');
                return;
            }

            if (accountActiveUntil && currentDate.getTime() > accountActiveUntil.getTime()) {
                setLoginMessage(`üö´ Cuenta Caducada: Tu cuenta ha expirado. Contacta al administrador para reactivarla.`, 'error');
                return;
            }

            currentUser = user;
            document.getElementById('welcomeUserName').textContent = user.fullName;
            saveState();
            showWelcome();
        } else {
            setLoginMessage('Usuario, n√∫mero de control o contrase√±a incorrectos', 'error');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPassword').value = '';
        }
    }


    function logout() {
        document.getElementById('loginPassword').value = '';
        currentUser = null;
        cart = [];
        updateCartCount();
        saveState();
        clearLoginFields();
        showLogin();
    }

    function adminLogout() {
        document.getElementById('loginPassword').value = '';
        currentUser = null;
        saveState();
        clearLoginFields();
        showLogin();
    }

    function showWelcome() {
        document.getElementById('welcomeScreen').classList.remove('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('customerMenu').classList.add('hidden');
        document.getElementById('cartScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
        document.getElementById('productPreviewModal').classList.add('hidden');
    }

    function showCustomerMenu() {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('customerMenu').classList.remove('hidden');
        document.getElementById('cartScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
        document.getElementById('productPreviewModal').classList.add('hidden');
        renderProducts();
        updateCartCount();
    }

    function showCart() {
        document.getElementById('cartScreen').classList.remove('hidden');
        document.getElementById('customerMenu').classList.add('hidden');
        document.getElementById('productPreviewModal').classList.add('hidden');
        renderCart();
    }

    function showAdminPanel() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('customerMenu').classList.add('hidden');
        document.getElementById('cartScreen').classList.add('hidden');
        document.getElementById('productPreviewModal').classList.add('hidden');
        showAdminStock();
    }

    // ====================================================================================
    // F U N C I O N E S¬† D E¬† S T O C K¬† Y¬† R E C E T A S (Se mantiene la l√≥gica central)
    // ====================================================================================

    function getRawMaterial(id) {
        return rawMaterials.find(m => m.id === id);
    }

    function checkRawMaterialStock(product, quantity) {
        // Los productos de proveedor (isSupplierProduct: true) no necesitan materia prima,
        // su stock es el stock directo de producto final (revisado en renderProducts)
        if (product.isSupplierProduct) return true;

        if (!product.materialsNeeded || product.materialsNeeded.length === 0) return true;

        for (const material of product.materialsNeeded) {
            const rawMaterial = getRawMaterial(material.materialId);
            if (!rawMaterial) {
                console.warn(`Materia prima ID ${material.materialId} no encontrada.`);
                continue;
            }

            const required = material.quantity * quantity;

            if (rawMaterial.stock < required - 0.001) {
                console.log(`Falta MP para ${product.name}. Stock de ${rawMaterial.name}: ${rawMaterial.stock}, requerido: ${required}.`);
                return false;
            }
        }
        return true;
    }

    function depleteRawMaterialStock(items) {
        items.forEach(cartItem => {
            const product = products.find(p => p.id === cartItem.id);
            if (!product || product.isSupplierProduct || !product.materialsNeeded) return;

            product.materialsNeeded.forEach(material => {
                const rawMaterial = getRawMaterial(material.materialId);
                if (rawMaterial) {
                    const depletionAmount = material.quantity * cartItem.quantity;
                    rawMaterial.stock = parseFloat((rawMaterial.stock - depletionAmount).toFixed(2));
                }
            });
        });
    }


    // ====================================================================================
    // F U N C I O N E S¬† P A N E L¬† A D M I N I S T R A D O R¬† ( V I S T A S )
    // ====================================================================================

    function activateTab(targetId) {
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.classList.remove('bg-blue-600', 'text-white');
            tab.classList.add('bg-gray-200', 'text-gray-700');
        });
        document.getElementById(targetId).classList.remove('bg-gray-200', 'text-gray-700');
        document.getElementById(targetId).classList.add('bg-blue-600', 'text-white');

        const sections = [
            'adminStockSection',
            'adminRawMaterialsSection',
            'adminSupplierPurchasesSection',
            'adminOrdersSection',
            'adminStatsSection',
            'adminUsersSection',
            'adminMemorySection',
            'adminPersonalDataSection',
            'adminReportsSection',
            'adminSupplierStockSection',
            'adminInvoicingSection' // üëà NUEVA SECCI√ìN
        ];
        sections.forEach(id => document.getElementById(id).classList.add('hidden'));
    }

    function showAdminStock() {
        activateTab('stockTab');
        document.getElementById('adminStockSection').classList.remove('hidden');
        showAdminFinalProducts(currentAdminProductType); // Muestra la sub-pesta√±a activa
    }

    // NUEVA FUNCI√ìN: Mostrar Productos finales (manufactured o supplier)
    function showAdminFinalProducts(type) {
        currentAdminProductType = type;
        document.getElementById('adminProductList').classList.add('hidden');
        document.getElementById('adminSupplierProductList').classList.add('hidden');

        document.querySelectorAll('.product-type-tab').forEach(tab => {
            tab.classList.remove('bg-blue-600', 'text-white');
            tab.classList.add('bg-gray-200', 'text-gray-700');
        });

        if (type === 'manufactured') {
            document.getElementById('adminProductList').classList.remove('hidden');
            document.getElementById('manufacturedStockTab').classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('manufacturedStockTab').classList.add('bg-blue-600', 'text-white');
            document.getElementById('productStockTitle').textContent = 'Gesti√≥n de Stock de Productos Finales (Hechos en Casa)';
            renderAdminProducts('manufactured');
        } else if (type === 'supplier') {
            document.getElementById('adminSupplierProductList').classList.remove('hidden');
            document.getElementById('supplierProductsStockTab').classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('supplierProductsStockTab').classList.add('bg-blue-600', 'text-white');
            document.getElementById('productStockTitle').textContent = 'Gesti√≥n de Stock de Productos Finales (de Proveedores)';
            renderAdminProducts('supplier');
        }
    }


    function showAdminRawMaterials() {
        activateTab('rawMaterialsTab');
        document.getElementById('adminRawMaterialsSection').classList.remove('hidden');
        renderAdminRawMaterials();
    }

    // NUEVA FUNCI√ìN: Mostrar Stock de Productos de Proveedores (MP de Proveedor)
    function showAdminSupplierStock() {
        activateTab('supplierStockTab');
        document.getElementById('adminSupplierStockSection').classList.remove('hidden');
        renderAdminSupplierStock();
    }

    function showAdminSupplierPurchases() {
        activateTab('supplierPurchasesTab');
        document.getElementById('adminSupplierPurchasesSection').classList.remove('hidden');
        renderSupplierPurchaseStats();
        renderAdminSupplierPurchases();
    }

    function showAdminOrders() {
        activateTab('ordersTab');
        document.getElementById('adminOrdersSection').classList.remove('hidden');
        renderAdminOrders();
    }

    function showAdminStats() {
        activateTab('statsTab');
        document.getElementById('adminStatsSection').classList.remove('hidden');
        renderSalesStats();
    }

    function showAdminUsers() {
        activateTab('usersTab');
        document.getElementById('adminUsersSection').classList.remove('hidden');
        renderAdminUsers();
    }

    function showAdminMemory() {
        activateTab('memoryTab');
        document.getElementById('adminMemorySection').classList.remove('hidden');
        renderLocalMemory();
    }

    // NUEVO: mostrar Datos Personales
    function showAdminPersonalData() {
        activateTab('personalDataTab');
        document.getElementById('adminPersonalDataSection').classList.remove('hidden');
        renderAdminPersonalData();
    }

    // NUEVO: mostrar Reportes
    function showAdminReports() {
        activateTab('reportsTab');
        document.getElementById('adminReportsSection').classList.remove('hidden');
        renderReportPreview();
    }

    function renderLocalMemory() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const memoryList = document.getElementById('memoryList');
        let html = '';
        let totalSize = 0;

        for (const key in localStorage) {
            if (localStorage.hasOwnProperty(key) && key.startsWith('cafetec_')) {
                const value = localStorage.getItem(key);
                const size = value.length;
                totalSize += size;

                let displayValue = value;
                try {
                    const parsed = JSON.parse(value);
                    displayValue = JSON.stringify(parsed, null, 2).substring(0, 500) + '...';
                } catch {
                    displayValue = value.substring(0, 500) + '...';
                }

                html += `
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <h4 class="font-bold text-lg">${key.replace('cafetec_', '').toUpperCase()}</h4>
                        <p class="text-xs text-gray-500 mb-2">Tama√±o: ${(size / 1024).toFixed(2)} KB</p>
                        <pre class="bg-gray-100 p-2 text-xs rounded overflow-x-auto whitespace-pre-wrap">${displayValue}</pre>
                    </div>
                `;
            }
        }

        if (totalSize > 0) {
            html = `<p class="text-sm font-medium mb-4">Total de datos almacenados: ${(totalSize / 1024).toFixed(2)} KB</p>` + html;
        } else {
            html = `<p class="text-center text-gray-500 py-8">No hay datos de CAFE-TEC guardados en la memoria local.</p>`;
        }

        memoryList.innerHTML = html;
    }

    function clearLocalMemory() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        if (confirm("¬°ADVERTENCIA! ¬øEst√°s seguro de que deseas borrar TODOS los datos guardados localmente (productos, usuarios, pedidos, etc.)? Esta acci√≥n es irreversible.")) {
            for (const key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('cafetec_')) {
                    localStorage.removeItem(key);
                }
            }

            products = [];
            rawMaterials = [];
            orders = [];
            users = [];
            currentUser = null;
            orderIdCounter = 1;

            location.reload();
        }
    }

    // ====================================================================================
    // F U N C I O N E S¬† M E N √ö¬† C L I E N T E
    // ====================================================================================

    function renderProducts() {
        const productList = document.getElementById('productList');
        const filteredProducts = currentCategory === 'all'
            ? products
            : products.filter(p => p.category === currentCategory);

        productList.innerHTML = filteredProducts.map(product => {
            const isOutOfStock = product.stock === 0 || (!product.isSupplierProduct && !checkRawMaterialStock(product, 1));
            // Si es producto de proveedor y stock es 0, tambi√©n est√° agotado.
            // Si es hecho en casa y stock final es 0, o falta MP, est√° agotado.

            return `
                <div 
                    class="bg-white border rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow"
                    onclick="showProductPreview(${product.id})"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">${product.emoji}</span>
                                <h3 class="font-semibold text-lg">${product.name}</h3>
                            </div>
                            <p class="text-2xl font-bold text-amber-600">$${product.price.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Stock: ${product.stock} ${isOutOfStock ? '<span class="text-red-500 font-bold">(Limitado)</span>' : ''}</p>
                        </div>
                        <button 
                            onclick="event.stopPropagation(); addToCart(${product.id})" 
                            ${isOutOfStock ? 'disabled' : ''}
                            class="px-4 py-2 rounded-lg font-medium transition-colors ${isOutOfStock
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    : 'bg-amber-600 text-white hover:bg-amber-700'
                }"
                        >
                            ${isOutOfStock ? 'Agotado' : 'Agregar'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function showProductPreview(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;

        previewProduct = product;

        document.getElementById('previewProductName').textContent = product.name;
        document.getElementById('previewProductDescription').textContent = product.description;
        document.getElementById('previewProductPrice').textContent = `$${product.price.toFixed(2)}`;
        document.getElementById('previewTime').textContent = product.time || 'N/A';
        document.getElementById('previewCalories').textContent = product.calories || 'N/A';

        // Ocultar tiempo de preparaci√≥n si es un producto de proveedor
        const timeContainer = document.getElementById('previewTimeContainer');
        if (product.isSupplierProduct) {
            timeContainer.classList.add('hidden');
        } else {
            timeContainer.classList.remove('hidden');
        }


        const isOutOfStock = product.stock === 0 || (!product.isSupplierProduct && !checkRawMaterialStock(product, 1));
        document.getElementById('previewStock').textContent = isOutOfStock ? 'Agotado' : `${product.stock} disp.`;

        const imageContainer = document.getElementById('previewImageContainer');
        const imageSource = product.imageLocal || product.imageURL || 'https://images.unsplash.com/photo-1541167760496-1628856ab22d?q=80&w=2047&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';
        imageContainer.style.backgroundImage = `url(${imageSource})`;

        const addButton = document.getElementById('previewAddToCartButton');
        document.getElementById('previewQuantity').textContent = 1;
        addButton.disabled = isOutOfStock;
        addButton.textContent = isOutOfStock ? 'Agotado' : 'Agregar al Carrito';
        addButton.classList.toggle('bg-green-600', !isOutOfStock);
        addButton.classList.toggle('hover:bg-green-700', !isOutOfStock);
        addButton.classList.toggle('bg-gray-400', isOutOfStock);

        document.getElementById('productPreviewModal').classList.remove('hidden');
    }

    function closeProductPreview() {
        document.getElementById('productPreviewModal').classList.add('hidden');
        previewProduct = null;
    }

    function updatePreviewQuantity(change) {
        if (!previewProduct) return;
        const quantityEl = document.getElementById('previewQuantity');
        let currentQuantity = parseInt(quantityEl.textContent);
        let newQuantity = currentQuantity + change;

        if (newQuantity < 1) newQuantity = 1;

        if (newQuantity > previewProduct.stock) {
            alert(`Stock limitado a ${previewProduct.stock} unidades.`);
            newQuantity = previewProduct.stock;
        } else if (!previewProduct.isSupplierProduct && !checkRawMaterialStock(previewProduct, newQuantity)) {
            alert('Materia prima insuficiente para esta cantidad.');
            newQuantity = currentQuantity;
        }

        quantityEl.textContent = newQuantity;
    }

    function addToCartFromPreview() {
        if (!previewProduct) return;
        const quantity = parseInt(document.getElementById('previewQuantity').textContent);

        const existingItem = cart.find(item => item.id === previewProduct.id);
        const totalNewQuantity = (existingItem ? existingItem.quantity : 0) + quantity;

        if (totalNewQuantity > previewProduct.stock) {
            alert(`Solo hay ${previewProduct.stock - (existingItem ? existingItem.quantity : 0)} unidades m√°s disponibles.`);
            return;
        }

        if (!previewProduct.isSupplierProduct && !checkRawMaterialStock(previewProduct, totalNewQuantity)) {
            alert('Materia prima insuficiente para completar la cantidad deseada en el carrito.');
            return;
        }

        if (existingItem) {
            existingItem.quantity = totalNewQuantity;
        } else {
            cart.push({ ...previewProduct, quantity: quantity });
        }

        updateCartCount();
        closeProductPreview();
        renderProducts();
        alert(`${quantity}x ${previewProduct.name} agregado al carrito.`);
    }

    function filterCategory(category) {
        currentCategory = category;

        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('bg-amber-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });

        const targetButton = Array.from(document.querySelectorAll('.category-btn')).find(btn => btn.textContent.toLowerCase().includes(category.toLowerCase()) || (category === 'all' && btn.textContent.toLowerCase().includes('todos')));

        if (targetButton) {
            targetButton.classList.remove('bg-gray-200', 'text-gray-700');
            targetButton.classList.add('bg-amber-600', 'text-white');
        }

        renderProducts();
    }

    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product || product.stock === 0) return;

        const existingItem = cart.find(item => item.id === productId);
        const quantityToAdd = existingItem ? existingItem.quantity + 1 : 1;

        if (quantityToAdd > product.stock) {
            alert('Stock del producto final agotado o l√≠mite alcanzado.');
            return;
        }

        if (!product.isSupplierProduct && !checkRawMaterialStock(product, quantityToAdd)) {
            alert('Stock de materia prima insuficiente para a√±adir m√°s unidades de este producto.');
            return;
        }

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...product, quantity: 1 });
        }

        updateCartCount();
        renderProducts();
    }

    function updateCartCount() {
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartCountEl = document.getElementById('cartCount');

        if (count > 0) {
            cartCountEl.textContent = count;
            cartCountEl.classList.remove('hidden');
        } else {
            cartCountEl.classList.add('hidden');
        }
    }

    function renderCart() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const cartItems = document.getElementById('cartItems');
        const totalPrice = document.getElementById('totalPrice');

        if (cart.length === 0) {
            cartItems.innerHTML = '<p class="text-center text-gray-500 py-8">Tu carrito est√° vac√≠o</p>';
            totalPrice.textContent = '$0.00';
            return;
        }

        cartItems.innerHTML = cart.map(item => `
            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                <div class="flex items-center">
                    <span class="text-xl mr-3">${item.emoji}</span>
                    <div>
                        <h4 class="font-medium">${item.name}</h4>
                        <p class="text-sm text-gray-600">$${item.price.toFixed(2)} c/u</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="updateQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">-</button>
                    <span class="w-8 text-center">${item.quantity}</span>
                    <button onclick="updateQuantity(${item.id}, 1)" class="w-8 h-8 bg-amber-600 text-white rounded-full flex items-center justify-center">+</button>
                </div>
            </div>
        `).join('');

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        totalPrice.textContent = `$${total.toFixed(2)}`;
    }

    function updateQuantity(productId, change) {
        const cartItem = cart.find(item => item.id === productId);
        const product = products.find(p => p.id === productId);

        if (cartItem) {
            const newQuantity = cartItem.quantity + change;

            if (newQuantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            } else if (newQuantity <= product.stock) {
                if (!product.isSupplierProduct && change > 0 && !checkRawMaterialStock(product, newQuantity)) {
                    alert('Stock de materia prima insuficiente para aumentar la cantidad.');
                    return;
                }
                cartItem.quantity = newQuantity;
            }

            updateCartCount();
            renderCart();
        }
    }

    function showPaymentDetails() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        const cardDetails = document.getElementById('cardPaymentDetails');
        const transferDetails = document.getElementById('transferDetails');

        cardDetails.classList.add('hidden');
        transferDetails.classList.add('hidden');

        if (paymentMethod === 'tarjeta') {
            cardDetails.classList.remove('hidden');
        } else if (paymentMethod === 'transferencia') {
            transferDetails.classList.remove('hidden');
        }
    }

    function validatePaymentInfo(paymentMethod) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        if (paymentMethod === 'tarjeta') {
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const cardExpiry = document.getElementById('cardExpiry').value.trim();
            const cardCvv = document.getElementById('cardCvv').value.trim();
            const cardHolder = document.getElementById('cardHolder').value.trim();

            if (!cardNumber || !cardExpiry || !cardCvv || !cardHolder) {
                alert('Por favor completa todos los datos de la tarjeta');
                return false;
            }
        }
        return true;
    }

    function generateReferenceNumber() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const timestamp = Date.now().toString();
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `CT${timestamp.slice(-6)}${random}`;
    }

    // ====================================================================================
    // ========= FUNCI√ìN `confirmOrder` MODIFICADA Y NUEVAS FUNCIONES DE MODAL =========
    // ====================================================================================

    function confirmOrder() {
        if (cart.length === 0) {
            alert('Tu carrito est√° vac√≠o');
            return;
        }

        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        if (!validatePaymentInfo(paymentMethod)) {
            return;
        }

        for (const item of cart) {
            const product = products.find(p => p.id === item.id);
            if (!product) continue;

            if (item.quantity > product.stock) {
                alert(`ERROR: Stock de producto final insuficiente para ${item.name} x${item.quantity}.`);
                return;
            }

            if (!product.isSupplierProduct && !checkRawMaterialStock(product, item.quantity)) {
                alert(`ERROR: Materia prima insuficiente para preparar ${item.name} x${item.quantity}. Por favor reduce la cantidad.`);
                return;
            }
        }

        const pickupTime = document.querySelector('input[name="pickup-time"]:checked').value;
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const orderNotes = document.getElementById('orderNotes').value.trim();
        const referenceNumber = generateReferenceNumber();

        const timeFormatted = formatTime(pickupTime);

        const newOrder = {
            id: orderIdCounter++,
            referenceNumber: referenceNumber,
            items: [...cart], // Importante clonar el carrito
            total: total,
            paymentMethod: paymentMethod,
            pickupTime: pickupTime,
            pickupTimeFormatted: timeFormatted,
            user: currentUser,
            notes: orderNotes,
            status: 'pendiente',
            isPaid: paymentMethod === 'tarjeta' || paymentMethod === 'transferencia',
            timestamp: new Date().toLocaleString(),
            date: new Date().toISOString().slice(0, 10),
        };

        orders.push(newOrder);

        // 1. Descontar stock de productos finales (Aplica a todos, hechos en casa y de proveedor)
        cart.forEach(cartItem => {
            const product = products.find(p => p.id === cartItem.id);
            if (product) {
                product.stock -= cartItem.quantity;
            }
        });

        // 2. Descontar materia prima (Solo aplica a productos hechos en casa)
        depleteRawMaterialStock(cart);

        // 3. Poblar el modal del ticket
        populateTicket(newOrder);

        // 4. Mostrar el modal
        document.getElementById('orderConfirmationModal').classList.remove('hidden');

        // El c√≥digo de limpieza se movi√≥ a `closeConfirmationModal()` para que el usuario pueda ver su ticket antes de que el carrito se vac√≠e.
    }

    /**
     * NUEVA FUNCI√ìN: Rellena el modal del ticket con los datos del pedido.
     */
    function populateTicket(order) {
        // ... (Se mantiene igual)
        document.getElementById('ticket-ref').textContent = order.referenceNumber;
        document.getElementById('ticket-user').textContent = order.user.fullName;
        document.getElementById('ticket-time').textContent = order.pickupTimeFormatted;
        document.getElementById('ticket-payment').textContent = order.paymentMethod;
        document.getElementById('ticket-total').textContent = `$${order.total.toFixed(2)}`;

        const itemsContainer = document.getElementById('ticket-items');
        itemsContainer.innerHTML = order.items.map(item => `
            <tr class="align-top">
                <td class="pr-2">${item.quantity}x</td>
                <td>${item.name}</td>
                <td class="text-right whitespace-nowrap">$${(item.price * item.quantity).toFixed(2)}</td>
            </tr>
        `).join('');
    }

    /**
     * NUEVA FUNCI√ìN: Se llama al presionar "Aceptar" en el modal de confirmaci√≥n.
     * Limpia el carrito y regresa al men√∫.
     */
    function closeConfirmationModal() {
        // Ahora movemos aqu√≠ toda la l√≥gica de limpieza
        cart = [];
        document.getElementById('orderNotes').value = '';
        document.getElementById('cardNumber').value = '';
        document.getElementById('cardExpiry').value = '';
        document.getElementById('cardCvv').value = '';
        document.getElementById('cardHolder').value = '';

        updateCartCount();
        saveState(); // Guardamos el estado despu√©s de vaciar el carrito y actualizar stock

        // Ocultamos el modal
        document.getElementById('orderConfirmationModal').classList.add('hidden');

        // Regresamos al men√∫
        showCustomerMenu();
    }

    function formatTime(time) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const [hours, minutes] = time.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        return `${displayHour}:${minutes} ${ampm}`;
    }

    // ====================================================================================
    // F U N C I O N E S¬† P A N E L¬† A D M I N I S T R A D O R¬† ( G E S T I √ì N )
    // ====================================================================================

    // FUNCI√ìN MODIFICADA: Ahora recibe el tipo de producto (manufactured o supplier)
    function renderAdminProducts(type) {
        const listContainer = type === 'manufactured' ? document.getElementById('adminProductList') : document.getElementById('adminSupplierProductList');
        const filteredProducts = products.filter(p => (p.isSupplierProduct === true && type === 'supplier') || (p.isSupplierProduct !== true && type === 'manufactured'));

        if (filteredProducts.length === 0) {
            listContainer.innerHTML = `<p class="text-center text-gray-500 py-8">No hay productos de ${type === 'manufactured' ? 'hechos en casa' : 'proveedores'} registrados.</p>`;
            return;
        }

        listContainer.innerHTML = filteredProducts.map(product => {
            const getMaterialInfo = (id) => {
                const material = getRawMaterial(id);
                return material ? `${material.emoji} ${material.name} (${material.unit})` : 'MP Desconocida';
            };

            const recipeHtml = product.isSupplierProduct ?
                '<span class="text-xs text-green-500 italic">‚úÖ Producto Final de Proveedor</span>' :
                (product.materialsNeeded && product.materialsNeeded.length > 0
                    ? product.materialsNeeded.map(mat => {
                        const material = getRawMaterial(mat.materialId);
                        if (!material) return '';
                        const isStockLow = material.stock < mat.quantity * 5;
                        return `<span class="text-xs ${isStockLow ? 'text-red-500 font-semibold' : 'text-gray-600'} block">
                                ${mat.quantity} ${material.unit} de ${material.name}
                            </span>`;
                    }).join('')
                    : '<span class="text-xs text-red-500 italic">‚ö†Ô∏è Sin Receta Vinculada</span>');


            return `
                <div class="bg-gray-50 border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <span class="text-xl mr-3">${product.emoji}</span>
                                <div>
                                    <h4 class="font-medium">${product.name}</h4>
                                    <p class="text-sm text-gray-600">$${product.price.toFixed(2)} - ${product.category}</p>
                                </div>
                            </div>
                            <div class="mt-2 text-left p-2 border-l-4 border-indigo-300 bg-white shadow-inner">
                                <p class="text-xs font-semibold mb-1 text-indigo-700">${product.isSupplierProduct ? 'Tipo de Producto' : 'Receta por 1 unidad'}:</p>
                                ${recipeHtml}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2 ml-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-600">Stock</p>
                                <p class="font-bold ${product.stock < 5 ? 'text-red-600' : 'text-green-600'}">${product.stock}</p>
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="${product.isSupplierProduct ? `editSupplierProduct(${product.id})` : `editProduct(${product.id})`}" 
                                    class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="deleteProduct(${product.id})" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderAdminRawMaterials() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const adminRawMaterialsList = document.getElementById('adminRawMaterialsList');

        adminRawMaterialsList.innerHTML = rawMaterials.map(material => `
            <div class="bg-gray-50 border rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-xl mr-3">${material.emoji}</span>
                        <div>
                            <h4 class="font-medium">${material.name}</h4>
                            <p class="text-sm text-gray-600">Unidad: ${material.unit}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Stock</p>
                            <p class="font-bold ${material.stock < 5 ? 'text-red-600' : 'text-green-600'}">${material.stock.toFixed(2)} ${material.unit}</p>
                        </div>
                        <button onclick="editRawMaterial(${material.id})" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // NUEVA FUNCI√ìN: Renderizar stock de productos de proveedor (misma estructura que MP)
    function renderAdminSupplierStock() {
        const listContainer = document.getElementById('adminSupplierStockList');
        const supplierProducts = products.filter(p => p.isSupplierProduct);

        if (supplierProducts.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No hay productos de proveedor registrados. A√±ade algunos.</p>';
            return;
        }

        listContainer.innerHTML = supplierProducts.map(product => `
            <div class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-xl mr-3">${product.emoji}</span>
                        <div>
                            <h4 class="font-medium">${product.name}</h4>
                            <p class="text-sm text-gray-600">Categor√≠a: ${product.category}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Stock</p>
                            <p class="font-bold ${product.stock < 5 ? 'text-red-600' : 'text-green-600'}">${product.stock}</p>
                        </div>
                        <button onclick="editSupplierProduct(${product.id})" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Funci√≥n para ABRIR MODAL de producto de proveedor
    function addNewSupplierProduct() {
        document.getElementById('supplierModalTitle').textContent = 'Nuevo Producto de Proveedor';
        document.getElementById('supplierProductForm').reset();
        document.getElementById('supplierProductId').value = '';
        document.getElementById('supplierProductDeleteContainer').classList.add('hidden');
        document.getElementById('supplierProductCategory').value = 'golosinas'; // Predeterminado a golosinas
        document.getElementById('supplierProductModal').classList.remove('hidden');
    }

    // Funci√≥n para EDITAR MODAL de producto de proveedor
    function editSupplierProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product || !product.isSupplierProduct) return;

        document.getElementById('supplierModalTitle').textContent = 'Editar Producto de Proveedor';
        document.getElementById('supplierProductId').value = product.id;
        document.getElementById('supplierProductName').value = product.name;
        document.getElementById('supplierProductEmoji').value = product.emoji || '';
        document.getElementById('supplierProductDescription').value = product.description || '';
        document.getElementById('supplierProductImageURL').value = product.imageURL || '';
        document.getElementById('supplierProductPrice').value = product.price;
        document.getElementById('supplierProductStock').value = product.stock;
        document.getElementById('supplierProductCategory').value = product.category; // Mantiene la categor√≠a actual (ej: golosinas)

        document.getElementById('supplierProductDeleteContainer').classList.remove('hidden');
        document.getElementById('supplierProductModal').classList.remove('hidden');
    }

    // Cerrar Modal de Producto de Proveedor
    function closeSupplierProductModal() {
        document.getElementById('supplierProductModal').classList.add('hidden');
    }

    // Eliminar Producto de Proveedor
    function deleteSupplierProduct(id) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar este producto de proveedor? Esta acci√≥n es permanente.')) {
            products = products.filter(p => p.id !== id);
            saveState();
            renderAdminSupplierStock();
            closeSupplierProductModal();
            renderProducts(); // Actualizar men√∫ cliente
        }
    }

    // Manejar el env√≠o del formulario de Producto de Proveedor
    document.getElementById('supplierProductForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const id = document.getElementById('supplierProductId').value;
        const name = document.getElementById('supplierProductName').value;
        const emoji = document.getElementById('supplierProductEmoji').value.trim().substring(0, 2);
        const description = document.getElementById('supplierProductDescription').value;
        const imageURL = document.getElementById('supplierProductImageURL').value;
        const price = parseFloat(document.getElementById('supplierProductPrice').value);
        const stock = parseInt(document.getElementById('supplierProductStock').value);
        const category = document.getElementById('supplierProductCategory').value;

        const productToSave = {
            id: id ? parseInt(id) : null,
            name, price, category, stock, emoji,
            materialsNeeded: [], // SIEMPRE vac√≠o para productos de proveedor
            isSupplierProduct: true, // SIEMPRE true
            description,
            time: '0 min', // Siempre 0 min
            calories: 'N/A', // Se podr√≠a a√±adir un campo en el futuro, por ahora N/A
            imageURL: imageURL,
            imageLocal: '',
        };

        if (id) {
            Object.assign(products.find(p => p.id === parseInt(id)), productToSave);
        } else {
            const newId = Math.max(...products.map(p => p.id), 0) + 1;
            productToSave.id = newId;
            products.push(productToSave);
        }

        saveState();
        renderAdminSupplierStock();
        closeSupplierProductModal();
        renderProducts(); // Actualizar men√∫ cliente
    });


    function renderSupplierPurchaseStats() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const statsContainer = document.getElementById('supplierStatsContainer');

        if (supplierPurchases.length === 0) {
            statsContainer.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <p class="text-sm text-blue-800">No hay datos suficientes para generar estad√≠sticas de compras.</p>
                </div>`;
            return;
        }

        const totalSpent = supplierPurchases.reduce((sum, purchase) => sum + purchase.cost, 0);
        const totalPurchases = supplierPurchases.length;
        const spendingBySupplier = supplierPurchases.reduce((acc, purchase) => {
            const supplier = purchase.supplierName || 'No especificado';
            acc[supplier] = (acc[supplier] || 0) + purchase.cost;
            return acc;
        }, {});
        const topSuppliers = Object.entries(spendingBySupplier).sort(([, a], [, b]) => b - a).slice(0, 3);
        const quantityByMaterial = supplierPurchases.reduce((acc, purchase) => {
            acc[purchase.materialId] = (acc[purchase.materialId] || 0) + purchase.quantity;
            return acc;
        }, {});

        let topMaterialByQuantity = { name: 'N/A', quantity: 0, unit: '' };
        if (Object.keys(quantityByMaterial).length > 0) {
            const topMaterialId = Object.keys(quantityByMaterial).reduce((a, b) => quantityByMaterial[a] > quantityByMaterial[b] ? a : b);
            const material = getRawMaterial(parseInt(topMaterialId));
            if (material) {
                topMaterialByQuantity = {
                    name: `${material.emoji} ${material.name}`,
                    quantity: quantityByMaterial[topMaterialId],
                    unit: material.unit
                };
            }
        }

        statsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-green-50 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-green-600 font-medium">üí∏ Gasto Total en Insumos</p>
                    <p class="text-2xl font-bold text-green-800">$${totalSpent.toFixed(2)}</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-purple-600 font-medium">üöö Total de Compras</p>
                    <p class="text-2xl font-bold text-purple-800">${totalPurchases}</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <h4 class="font-bold mb-2 text-md text-gray-700">üèÜ Top Proveedores (por Gasto)</h4>
                        <div class="space-y-2">
                            ${topSuppliers.length > 0 ? topSuppliers.map(([name, cost]) => `
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium truncate">${name}</span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">$${cost.toFixed(2)}</span>
                                </div>
                            `).join('') : '<p class="text-xs text-gray-500">No hay datos de proveedores.</p>'}
                        </div>
                    </div>
                        <div class="bg-white border rounded-lg p-4 shadow-sm">
                            <h4 class="font-bold mb-2 text-md text-gray-700">üì¶ Insumo M√°s Comprado (por Cantidad)</h4>
                            <div class="space-y-2">
                                ${topMaterialByQuantity.name !== 'N/A' ? `
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-medium">${topMaterialByQuantity.name}</span>
                                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">${topMaterialByQuantity.quantity.toFixed(2)} ${topMaterialByQuantity.unit}</span>
                                    </div>
                                ` : '<p class="text-xs text-gray-500">No hay compras registradas.</p>'}
                            </div>
                    </div>
            </div>`;
    }

    function renderAdminSupplierPurchases() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const listContainer = document.getElementById('adminSupplierPurchasesList');

        if (supplierPurchases.length === 0) {
            listContainer.innerHTML = '';
            return;
        }

        const sortedPurchases = [...supplierPurchases].sort((a, b) => new Date(b.date) - new Date(a.date));

        listContainer.innerHTML = sortedPurchases.map(purchase => {
            const material = getRawMaterial(purchase.materialId);
            if (!material) return '';

            return `
                <div class="bg-white border rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500">${new Date(purchase.date).toLocaleString()}</p>
                            <h4 class="font-bold text-lg">${material.emoji} ${material.name}</h4>
                            <p class="text-sm text-gray-600">Proveedor: <span class="font-medium">${purchase.supplierName || 'No especificado'}</span></p>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <p class="font-bold text-xl text-green-600">$${purchase.cost.toFixed(2)}</p>
                            <p class="text-gray-700">${purchase.quantity} ${material.unit}</p>
                            <div class="flex space-x-2 mt-2 justify-end">
                                <button onclick="editSupplierPurchase(${purchase.id})" title="Editar" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                                </button>
                                <button onclick="deleteSupplierPurchase(${purchase.id})" title="Eliminar" class="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function addNewRawMaterial() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        document.getElementById('materialModalTitle').textContent = 'Nueva Materia Prima';
        document.getElementById('rawMaterialForm').reset();
        document.getElementById('materialId').value = '';
        document.getElementById('materialDeleteContainer').classList.add('hidden');
        document.getElementById('materialName').readOnly = false;
        document.getElementById('materialUnit').readOnly = false;
        document.getElementById('rawMaterialModal').classList.remove('hidden');
    }

    function editRawMaterial(id) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const material = rawMaterials.find(m => m.id === id);
        if (material) {
            document.getElementById('materialModalTitle').textContent = 'Editar Materia Prima';
            document.getElementById('materialId').value = material.id;
            document.getElementById('materialName').value = material.name;
            document.getElementById('materialEmoji').value = material.emoji;
            document.getElementById('materialStock').value = material.stock;
            document.getElementById('materialUnit').value = material.unit;

            document.getElementById('materialName').readOnly = false;
            document.getElementById('materialUnit').readOnly = false;
            document.getElementById('materialDeleteContainer').classList.remove('hidden');

            document.getElementById('rawMaterialModal').classList.remove('hidden');
        }
    }

    function deleteRawMaterial(id) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        if (confirm('¬øEst√°s seguro de que quieres eliminar esta materia prima? Se eliminar√° de todas las recetas.')) {
            rawMaterials = rawMaterials.filter(m => m.id !== id);

            products.forEach(product => {
                if (product.materialsNeeded) {
                    product.materialsNeeded = product.materialsNeeded.filter(mat => mat.materialId !== id);
                }
            });

            saveState();
            renderAdminRawMaterials();
            closeRawMaterialModal();
            alert('Materia prima eliminada correctamente.');
        }
    }

    function closeRawMaterialModal() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        document.getElementById('rawMaterialModal').classList.add('hidden');
        document.getElementById('materialDeleteContainer').classList.add('hidden');
    }

    document.getElementById('rawMaterialForm').addEventListener('submit', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        e.preventDefault();

        const id = document.getElementById('materialId').value;
        const name = document.getElementById('materialName').value.trim();
        const emoji = document.getElementById('materialEmoji').value.trim();
        const stock = parseFloat(document.getElementById('materialStock').value);
        const unit = document.getElementById('materialUnit').value.trim();

        if (id) {
            const material = rawMaterials.find(m => m.id === parseInt(id));
            if (material) {
                material.name = name;
                material.emoji = emoji;
                material.stock = stock;
                material.unit = unit;
            }
        } else {
            const newId = Math.max(...rawMaterials.map(m => m.id), 100) + 1;
            rawMaterials.push({ id: newId, name, stock, unit, emoji });
        }

        saveState();
        renderAdminRawMaterials();
        closeRawMaterialModal();
    });

    function showNewPurchaseModal() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        document.getElementById('purchaseModalTitle').textContent = 'Registrar Compra';
        document.getElementById('supplierPurchaseForm').reset();
        document.getElementById('purchaseId').value = '';

        const selectEl = document.getElementById('purchaseMaterialId');
        selectEl.innerHTML = '<option value="">Seleccionar Materia Prima</option>' + rawMaterials.map(m =>
            `<option value="${m.id}">${m.emoji} ${m.name}</option>`
        ).join('');
        selectEl.disabled = false;

        document.getElementById('purchaseUnit').value = '';
        document.getElementById('supplierPurchaseModal').classList.remove('hidden');
    }

    function editSupplierPurchase(purchaseId) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const purchase = supplierPurchases.find(p => p.id === purchaseId);
        if (!purchase) return;

        showNewPurchaseModal();

        document.getElementById('purchaseModalTitle').textContent = 'Editar Compra';
        document.getElementById('purchaseId').value = purchase.id;
        document.getElementById('purchaseMaterialId').value = purchase.materialId;
        document.getElementById('purchaseMaterialId').disabled = true;
        document.getElementById('purchaseQuantity').value = purchase.quantity;
        document.getElementById('purchaseCost').value = purchase.cost;
        document.getElementById('supplierName').value = purchase.supplierName;

        const material = getRawMaterial(purchase.materialId);
        if (material) {
            document.getElementById('purchaseUnit').value = material.unit;
        }
    }

    function deleteSupplierPurchase(purchaseId) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const purchase = supplierPurchases.find(p => p.id === purchaseId);
        if (!purchase) return;

        if (confirm('¬øSeguro que quieres eliminar este registro de compra? Esta acci√≥n descontar√° la cantidad del stock de materia prima.')) {
            const material = getRawMaterial(purchase.materialId);
            if (material) {
                material.stock = Math.max(0, material.stock - purchase.quantity);
            }

            supplierPurchases = supplierPurchases.filter(p => p.id !== purchaseId);

            saveState();
            alert('Registro de compra eliminado y stock ajustado.');
            showAdminSupplierPurchases();
            renderAdminRawMaterials();
            renderAdminProducts();
        }
    }

    function closePurchaseModal() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        document.getElementById('supplierPurchaseModal').classList.add('hidden');
    }

    document.getElementById('purchaseMaterialId').addEventListener('change', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const materialId = e.target.value;
        if (materialId) {
            const material = getRawMaterial(parseInt(materialId));
            if (material) {
                document.getElementById('purchaseUnit').value = material.unit;
            }
        } else {
            document.getElementById('purchaseUnit').value = '';
        }
    });

    document.getElementById('supplierPurchaseForm').addEventListener('submit', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        e.preventDefault();

        const purchaseId = document.getElementById('purchaseId').value;
        const materialId = parseInt(document.getElementById('purchaseMaterialId').value);
        const newQuantity = parseFloat(document.getElementById('purchaseQuantity').value);
        const newCost = parseFloat(document.getElementById('purchaseCost').value);
        const newSupplierName = document.getElementById('supplierName').value.trim();

        if (!materialId || isNaN(newQuantity) || isNaN(newCost) || newQuantity <= 0 || newCost < 0) {
            alert("Por favor, completa los campos correctamente. La cantidad debe ser mayor a 0 y el costo no puede ser negativo.");
            return;
        }

        const material = getRawMaterial(materialId);
        if (!material) {
            alert("Error: Materia prima no encontrada.");
            return;
        }

        if (purchaseId) {
            const existingPurchase = supplierPurchases.find(p => p.id === parseInt(purchaseId));
            if (existingPurchase) {
                const quantityDifference = newQuantity - existingPurchase.quantity;
                material.stock += quantityDifference;

                existingPurchase.quantity = newQuantity;
                existingPurchase.cost = newCost;
                existingPurchase.supplierName = newSupplierName;
                alert('Compra actualizada y stock ajustado.');
            }
        } else {
            material.stock += newQuantity;
            const newPurchase = {
                id: (Math.max(0, ...supplierPurchases.map(p => p.id))) + 1,
                materialId,
                quantity: newQuantity,
                cost: newCost,
                supplierName: newSupplierName,
                date: new Date().toISOString()
            };
            supplierPurchases.push(newPurchase);
            alert(`Compra registrada. El nuevo stock de ${material.name} es ${material.stock.toFixed(2)} ${material.unit}.`);
        }

        saveState();
        showAdminSupplierPurchases();
        renderAdminRawMaterials();
        renderAdminProducts(currentAdminProductType); // Pasa el tipo de producto actual para refrescar la lista
        closePurchaseModal();
    });

    function renderAdminOrders() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const adminOrdersList = document.getElementById('adminOrdersList');

        if (orders.length === 0) {
            adminOrdersList.innerHTML = '<p class="text-center text-gray-500 py-8">No hay pedidos pendientes</p>';
            return;
        }

        adminOrdersList.innerHTML = orders.map(order => `
            <div class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <h4 class="font-bold text-lg">Pedido #${order.id}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${order.status === 'pendiente' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
            }">
                            ${order.status === 'pendiente' ? '‚è≥ Pendiente' : '‚úÖ Listo'}
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">${order.timestamp}</p>
                        <p class="font-bold text-lg text-blue-600">$${order.total.toFixed(2)}</p>
                    </div>
                </div>
        
                <div class="mb-3 p-3 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium">üë§ Cliente:</span>
                            <p>${order.user.fullName}</p>
                        </div>
                        <div>
                            <span class="font-medium">üìã Tipo:</span>
                            <p class="capitalize">${order.user.userType}</p>
                        </div>
                        ${order.user.userType === 'estudiante' ? `
                            <div>
                                <span class="font-medium">üéì Carrera:</span>
                                <p class="text-xs">${order.user.career || ''}</p>
                            </div>
                            <div>
                                <span class="font-medium">üìö Sem/Grupo:</span>
                                <p>${order.user.semester || ''}¬∞${order.user.group || ''}</p>
                            </div>
                            <div>
                                <span class="font-medium">üî¢ No. Control:</span>
                                <p class="font-mono text-xs">${order.user.controlNumber || ''}</p>
                            </div>
                        ` : `
                            <div>
                                <span class="font-medium">üìû Tel√©fono:</span>
                                <p>${order.user.phoneNumber || ''}</p>
                            </div>
                        `}
                        <div>
                            <span class="font-medium">üî¢ Referencia:</span>
                            <p class="font-mono text-xs">${order.referenceNumber}</p>
                        </div>
                        <div>
                            <span class="font-medium">üïê Recogida:</span>
                            <p>${order.pickupTimeFormatted}</p>
                        </div>
                    </div>
                    ${order.notes ? `
                        <div class="mt-2">
                            <span class="font-medium text-sm">üìù Notas:</span>
                            <p class="text-sm text-gray-600 italic">"${order.notes}"</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="mb-3">
                    <h5 class="font-medium mb-2">Productos:</h5>
                    <div class="space-y-1">
                        ${order.items.map(item => `
                            <div class="flex justify-between text-sm">
                                <span>${item.emoji} ${item.name} x${item.quantity}</span>
                                <span>$${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-2 mb-3 text-sm">
                    <div class="flex justify-between">
                        <span class="font-medium">üí≥ M√©todo de pago:</span>
                        <span class="capitalize">${order.paymentMethod}</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-3 border-t">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium">Estado del pago:</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${order.isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }">
                            ${order.isPaid ? '‚úÖ Pagado' : '‚ùå Pendiente'}
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="toggleOrderStatus(${order.id})" class="px-3 py-1 rounded-lg text-sm font-medium ${order.status === 'pendiente' ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-yellow-600 text-white hover:bg-yellow-700'
            }">
                            ${order.status === 'pendiente' ? 'Marcar Listo' : 'Marcar Pendiente'}
                        </button>
                        <button onclick="togglePaymentStatus(${order.id})" class="px-3 py-1 rounded-lg text-sm font-medium ${order.isPaid ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-blue-600 text-white hover:bg-blue-700'
            }">
                            ${order.isPaid ? 'Marcar No Pagado' : 'Marcar Pagado'}
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // =================== FACTURACI√ìN CFDI (SIMULADA SAT) ===================

    // Datos del emisor (simulados). C√°mbialos por los reales de tu cafeter√≠a si los tienes:
    const EMISOR_FISCAL = {
        nombre: 'CAFE-TEC S.A. de C.V.',
        rfc: 'CACX7605101P8',
        regimen: '601 - General de Ley Personas Morales',
        cp: '30000'
    };

    function generateFakeUuid() {
        // Patr√≥n tipo UUID v4
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        }).toUpperCase();
    }

    function showAdminInvoicing() {
        activateTab('invoicingTab');
        document.getElementById('adminInvoicingSection').classList.remove('hidden');
        renderAdminInvoicing();
    }

    function renderAdminInvoicing() {
        const container = document.getElementById('adminInvoicingList');

        if (!orders || orders.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-8 text-sm">No hay pedidos registrados para facturar.</p>';
            return;
        }

        const sortedOrders = [...orders].sort((a, b) => b.id - a.id);

        container.innerHTML = sortedOrders.map(order => {
            const hasInvoice = !!order.invoice;
            const cliente = order.user ? order.user.fullName : 'Desconocido';
            const fecha = order.timestamp || '';
            const total = order.total || 0;

            return `
            <div class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <p class="font-semibold text-sm">Pedido #${order.id} ‚Ä¢ Ref: ${order.referenceNumber || '-'}</p>
                        <p class="text-xs text-gray-500">${fecha}</p>
                        <p class="text-xs text-gray-600 mt-1">Cliente: <span class="font-medium">${cliente}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Total</p>
                        <p class="text-lg font-bold text-blue-600">$${total.toFixed(2)}</p>
                        <span class="inline-flex items-center mt-1 px-2 py-0.5 rounded-full text-[0.65rem] font-medium ${hasInvoice ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${hasInvoice ? '‚úÖ Facturado' : '‚è≥ Sin factura'}
                        </span>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 mt-2">
                    <button onclick="openInvoiceForm(${order.id})"
                        class="px-3 py-1 rounded-lg text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">
                        ${hasInvoice ? '‚úèÔ∏è Editar Factura' : 'üßæ Generar Factura'}
                    </button>
                    <button onclick="openInvoiceTicket(${order.id})"
                        ${hasInvoice ? '' : 'disabled'}
                        class="px-3 py-1 rounded-lg text-xs font-medium ${hasInvoice ? 'bg-gray-100 text-gray-800 hover:bg-gray-200' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">
                        üìÑ Ver Ticket
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }

    function openInvoiceForm(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order) {
            alert('No se encontr√≥ el pedido a facturar.');
            return;
        }

        document.getElementById('invoiceOrderId').value = order.id;
        document.getElementById('invoiceOrderInfo').textContent = `#${order.id} (${order.referenceNumber || 'SIN REF'})`;
        document.getElementById('invoiceOrderClient').textContent = order.user ? order.user.fullName : 'Desconocido';
        document.getElementById('invoiceOrderTotal').textContent = `$${order.total.toFixed(2)}`;

        const invoice = order.invoice;

        // Si ya hay factura, rellenamos datos; si no, ponemos valores por defecto
        document.getElementById('invoiceRfc').value = invoice?.receptor?.rfc || '';
        document.getElementById('invoiceRazon').value = invoice?.receptor?.nombre || (order.user ? order.user.fullName : '');
        document.getElementById('invoiceCp').value = invoice?.receptor?.cp || '30000';
        document.getElementById('invoiceRegimenReceptor').value = invoice?.receptor?.regimen || '605 - Sueldos y salarios';
        document.getElementById('invoiceUsoCfdi').value = invoice?.usoCfdi || 'G03';
        document.getElementById('invoiceEmail').value = invoice?.receptor?.email || '';

        // Mapear m√©todo de pago de la orden a forma de pago SAT
        let formaPagoDefault = '01'; // Efectivo
        if (order.paymentMethod === 'tarjeta') formaPagoDefault = '04';
        if (order.paymentMethod === 'transferencia') formaPagoDefault = '03';

        document.getElementById('invoiceFormaPago').value = invoice?.formaPago || formaPagoDefault;
        document.getElementById('invoiceMetodoPago').value = invoice?.metodoPago || 'PUE';

        document.getElementById('invoiceModal').classList.remove('hidden');
    }

    function closeInvoiceModal() {
        document.getElementById('invoiceModal').classList.add('hidden');
    }

    function renderSalesStats() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const adminStatsList = document.getElementById('adminStatsList');

        if (orders.length === 0) {
            adminStatsList.innerHTML = '<p class="text-center text-gray-500 py-8">No hay datos de ventas para generar estad√≠sticas.</p>';
            return;
        }

        const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);

        const customerTypeCounts = orders.reduce((acc, order) => {
            const type = order.user.userType;
            acc[type] = (acc[type] || 0) + 1;
            return acc;
        }, {});

        const productSales = orders.flatMap(order => order.items).reduce((acc, item) => {
            acc[item.name] = (acc[item.name] || 0) + item.quantity;
            return acc;
        }, {});
        const topProducts = Object.entries(productSales)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        const paymentMethodSales = orders.reduce((acc, order) => {
            const method = order.paymentMethod;
            acc[method] = (acc[method] || 0) + 1;
            return acc;
        }, {});

        adminStatsList.innerHTML = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg shadow">
                    <p class="text-sm text-blue-600 font-medium">üí∞ Total de Ingresos</p>
                    <p class="text-2xl font-bold text-blue-800">$${totalRevenue.toFixed(2)}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow">
                    <p class="text-sm text-green-600 font-medium">üìã Total de Pedidos</p>
                    <p class="text-2xl font-bold text-green-800">${orders.length}</p>
                </div>
            </div>
        
            <div class="space-y-6">
                <div class="bg-white border rounded-lg p-4 shadow-sm">
                    <h4 class="font-bold mb-3 text-lg text-amber-700">üèÜ Top 5 Productos Vendidos</h4>
                    <div class="space-y-2">
                        ${topProducts.map(([name, quantity], index) => `
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-medium">${index + 1}. ${name}</span>
                                <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded-full text-xs">${quantity} unidades</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-white border rounded-lg p-4 shadow-sm">
                    <h4 class="font-bold mb-3 text-lg text-indigo-700">üë• Distribuci√≥n de Clientes</h4>
                    <div class="space-y-2">
                        ${Object.entries(customerTypeCounts).map(([type, count]) => `
                            <div class="flex justify-between items-center text-sm capitalize">
                                <span class="font-medium">${type}</span>
                                <span class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs">${count} pedidos (${((count / orders.length) * 100).toFixed(1)}%)</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-white border rounded-lg p-4 shadow-sm">
                    <h4 class="font-bold mb-3 text-lg text-teal-700">üí≥ M√©todos de Pago Usados</h4>
                    <div class="space-y-2">
                        ${Object.entries(paymentMethodSales).map(([method, count]) => `
                            <div class="flex justify-between items-center text-sm capitalize">
                                <span class="font-medium">${method}</span>
                                <span class="px-2 py-1 bg-teal-100 text-teal-800 rounded-full text-xs">${count} pagos</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderAdminUsers() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const adminUsersList = document.getElementById('adminUsersList');

        if (users.length === 0) {
            adminUsersList.innerHTML = '<p class="text-center text-gray-500 py-8">No hay usuarios registrados</p>';
            return;
        }

        adminUsersList.innerHTML = users.map(user => {
            const statusPill = `<span class="ml-2 px-2 py-0.5 rounded-full text-xs ${user.isActive === false ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${user.isActive === false ? 'Desactivada' : 'Activa'}</span>`;
            return `
            <div class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-lg">
                                ${user.userType === 'estudiante' ? 'üë®‚Äçüéì' :
                    user.userType === 'profesor' ? 'üë®‚Äçüè´' :
                        user.userType === 'docente' ? 'üë©‚Äçüè´' : 'üë®‚Äçüíº'}
                            </span>
                        </div>
                        <div>
                            <h4 class="font-bold">${user.fullName} ${statusPill}</h4>
                            <p class="text-sm text-gray-600 capitalize">${user.userType}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">Registrado:</p>
                        <p class="text-xs text-gray-600">${user.registrationDate.toLocaleString()}</p>
                    </div>
                </div>
        
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium">üÜî Usuario:</span>
                        <p class="font-mono">${user.username}</p>
                    </div>
                    ${user.userType === 'estudiante' ? `
                        <div>
                            <span class="font-medium">üéì Carrera:</span>
                            <p class="text-xs">${user.career || ''}</p>
                        </div>
                        <div>
                            <span class="font-medium">üìö Semestre:</span>
                            <p>${user.semester || ''}¬∞</p>
                        </div>
                        <div>
                            <span class="font-medium">üë• Grupo:</span>
                            <p>${user.group || ''}</p>
                        </div>
                    ` : `
                        <div>
                            <span class="font-medium">üìû Tel√©fono:</span>
                            <p>${user.phoneNumber || ''}</p>
                        </div>
                    `}
                    <div>
                        <span class="font-medium">üìÑ Credencial:</span>
                        <p>${user.hasCredential ? '‚úÖ Subida' : '‚ùå No subida'}</p>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // ===================== NUEVO: Datos Personales (render + edici√≥n + ACTIVAR/DESACTIVAR) =====================

    function renderAdminPersonalData() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const list = document.getElementById('adminPersonalDataList');
        const q = (document.getElementById('personalSearchInput').value || '').toLowerCase().trim();
        const type = document.getElementById('personalFilterSelect').value;

        if (!users || users.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-500 py-8">No hay usuarios registrados.</p>';
            return;
        }

        let filtered = users.filter(u => u.id !== 0);

        if (type !== 'all') {
            filtered = filtered.filter(u => u.userType === type);
        }

        if (q) {
            filtered = filtered.filter(u => {
                const haystack = [
                    u.fullName, u.username, u.phoneNumber, u.controlNumber, u.career, u.group
                ].filter(Boolean).join(' ').toLowerCase();
                return haystack.includes(q);
            });
        }

        if (filtered.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-500 py-8">Sin resultados para el filtro/b√∫squeda.</p>';
            return;
        }

        list.innerHTML = filtered.map(u => `
            <div class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-xl">${u.userType === 'estudiante' ? 'üë®‚Äçüéì' : (u.userType === 'docente' ? 'üë©‚Äçüè´' : 'üë®‚Äçüíº')}</span>
                            <h4 class="font-bold">${u.fullName}</h4>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><span class="font-medium">Usuario:</span> <span class="font-mono">${u.username || ''}</span></div>
                            <div class="capitalize"><span class="font-medium">Tipo:</span> ${u.userType}</div>
                            ${u.userType === 'estudiante' ? `
                                <div><span class="font-medium">No. Control:</span> <span class="font-mono">${u.controlNumber || ''}</span></div>
                                <div><span class="font-medium">Carrera:</span> ${u.career || ''}</div>
                                <div><span class="font-medium">Semestre:</span> ${u.semester || ''}</div>
                                <div><span class="font-medium">Grupo:</span> ${u.group || ''}</div>
                            ` : `
                                <div><span class="font-medium">Tel√©fono:</span> ${u.phoneNumber || ''}</div>
                            `}
                            <div><span class="font-medium">Credencial:</span> ${u.hasCredential ? '‚úÖ' : '‚ùå'}</div>
                            <div><span class="font-medium">Registro:</span> ${u.registrationDate.toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="ml-4 space-y-2 text-right">
                        <div class="text-sm">
                            <span class="block mb-1 font-medium">Estado de cuenta</span>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" ${u.isActive === false ? '' : 'checked'}
                                    onchange="toggleUserActive(${u.id}, this.checked)">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-green-500 relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-5"></div>
                                <span class="ml-2 ${u.isActive === false ? 'text-red-700' : 'text-green-700'}">${u.isActive === false ? 'Desactivada' : 'Activa'}</span>
                            </label>
                        </div>
                        <button onclick="openEditUserModal(${u.id})" class="px-3 py-1 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">Editar</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function toggleUserActive(userId, isActive) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const user = users.find(u => u.id === userId);
        if (!user) return;
        user.isActive = !!isActive;
        saveState();
        // refrescar vistas que muestran estado
        renderAdminPersonalData();
        renderAdminUsers();

        // Si el admin desactiva a alguien que est√° logueado actualmente (raro, pero por si acaso)
        if (currentUser && currentUser.id === user.id && user.isActive === false) {
            alert('Esta cuenta ha sido desactivada y se cerrar√° la sesi√≥n.');
            logout();
        }
    }

    document.getElementById('personalSearchInput').addEventListener('input', renderAdminPersonalData);
    document.getElementById('personalFilterSelect').addEventListener('change', renderAdminPersonalData);

    function openEditUserModal(userId) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const user = users.find(u => u.id === userId);
        if (!user) return;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserType').value = user.userType;
        document.getElementById('editFullName').value = user.fullName || '';
        document.getElementById('editUsername').value = user.username || '';
        document.getElementById('editTecnologico').value = user.tecnologico || '';

        document.getElementById('editControlNumber').value = user.controlNumber || '';
        document.getElementById('editCareer').value = user.career || '';
        document.getElementById('editSemester').value = user.semester || '';
        document.getElementById('editGroup').value = user.group || '';
        document.getElementById('editPhoneNumber').value = user.phoneNumber || '';
        document.getElementById('editNewPassword').value = '';
        document.getElementById('editConfirmPassword').value = '';

        const regDate = user.registrationDate ? new Date(user.registrationDate) : null;
        const activeUntilDate = user.accountActiveUntil ? new Date(user.accountActiveUntil) : null;

        if (regDate) {
            document.getElementById('editRegistrationDate').value = new Date(regDate.getTime() - (regDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        }
        if (activeUntilDate) {
            document.getElementById('editAccountActiveUntil').value = new Date(activeUntilDate.getTime() - (activeUntilDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        }

        const isAdmin = currentUser && currentUser.username === 'ADMIN';
        document.getElementById('editRegistrationDate').disabled = !isAdmin;
        document.getElementById('editAccountActiveUntil').disabled = !isAdmin;

        toggleEditUserFields();
        document.getElementById('editUserModal').classList.remove('hidden');
    }

    function closeEditUserModal() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        document.getElementById('editUserModal').classList.add('hidden');
    }

    function toggleEditUserFields() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const type = document.getElementById('editUserType').value;
        const stu = document.getElementById('editStudentFields');
        const staff = document.getElementById('editStaffFields');

        if (type === 'estudiante') {
            stu.classList.remove('hidden');
            staff.classList.add('hidden');
        } else {
            stu.classList.add('hidden');
            staff.classList.remove('hidden');
        }
    }

    function propagateUserChanges(updatedUser) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        orders.forEach(o => {
            if (o.user && o.user.id === updatedUser.id) {
                o.user = {
                    ...o.user,
                    userType: updatedUser.userType,
                    fullName: updatedUser.fullName,
                    username: updatedUser.username,
                    phoneNumber: updatedUser.phoneNumber,
                    controlNumber: updatedUser.controlNumber,
                    career: updatedUser.career,
                    semester: updatedUser.semester,
                    group: updatedUser.group,
                    registrationDate: updatedUser.registrationDate
                };
            }
        });
    }

    document.getElementById('editUserForm').addEventListener('submit', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        e.preventDefault();

        const id = parseInt(document.getElementById('editUserId').value);
        const type = document.getElementById('editUserType').value;
        const fullName = document.getElementById('editFullName').value.trim();
        const username = document.getElementById('editUsername').value.trim();
        const tecnologico = document.getElementById('editTecnologico').value.trim();

        const newPass = document.getElementById('editNewPassword').value;
        const confirmPass = document.getElementById('editConfirmPassword').value;

        const regDateValue = document.getElementById('editRegistrationDate').value;
        const activeUntilValue = document.getElementById('editAccountActiveUntil').value;

        const user = users.find(u => u.id === id);
        if (!user) return;

        if (!fullName || !username) {
            alert('El nombre y el nombre de usuario no pueden estar vac√≠os.');
            return;
        }

        const dupUsername = users.some(u => u.id !== id && u.username.toLowerCase() === username.toLowerCase());
        if (dupUsername) {
            alert('Este nombre de usuario ya est√° registrado en otro usuario.');
            return; // Se mantiene alert aqu√≠ porque es un modal de admin, no la pantalla de login.
        }

        user.fullName = fullName;
        user.username = username;
        user.userType = type;
        user.tecnologico = tecnologico;

        if (type === 'estudiante') {
            const controlNumber = (document.getElementById('editControlNumber').value || '').trim();
            const career = document.getElementById('editCareer').value || '';
            const semester = document.getElementById('editSemester').value || '';
            const group = document.getElementById('editGroup').value || '';

            if (!controlNumber) {
                alert('Ingresa el n√∫mero de control.');
                return;
            }
            const dup = users.some(u => u.id !== id && u.controlNumber === controlNumber && u.userType === 'estudiante');
            if (dup) {
                alert('Este n√∫mero de control ya est√° registrado en otro estudiante.');
                return; // Se mantiene alert aqu√≠ porque es un modal de admin.
            }

            user.controlNumber = controlNumber;
            user.career = career;
            user.semester = semester;
            user.group = group;

            delete user.phoneNumber;

        } else {
            const phoneNumber = (document.getElementById('editPhoneNumber').value || '').trim();
            if (!phoneNumber) {
                alert('Ingresa el n√∫mero de tel√©fono.');
                return;
            }
            const dup = users.some(u => u.id !== id && u.phoneNumber === phoneNumber);
            if (dup) {
                alert('Este n√∫mero de tel√©fono ya est√° registrado en otro usuario.');
                return; // Se mantiene alert aqu√≠ porque es un modal de admin.
            }

            user.phoneNumber = phoneNumber;

            delete user.controlNumber;
            delete user.career;
            delete user.semester;
            delete user.group;
        }

        if (newPass || confirmPass) {
            if (newPass !== confirmPass) {
                alert('Las contrase√±as no coinciden.');
                return;
            }
            user.password = newPass;
        }

        user.registrationDate = regDateValue ? new Date(regDateValue) : user.registrationDate;
        user.accountActiveUntil = activeUntilValue ? new Date(activeUntilValue) : user.accountActiveUntil;

        propagateUserChanges(user);
        saveState();

        alert('Datos actualizados correctamente.');
        closeEditUserModal();
        renderAdminPersonalData();
        renderAdminUsers();
        if (!document.getElementById('adminOrdersSection').classList.contains('hidden')) {
            renderAdminOrders();
        }
    });

    function forcePropagateAllUsers() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        if (!confirm("¬øEst√°s seguro de que quieres sincronizar los datos de TODOS los usuarios con sus pedidos existentes?")) {
            return;
        }

        users.forEach(user => {
            propagateUserChanges(user);
        });

        saveState();
        alert("Sincronizaci√≥n completada. Los datos de los usuarios han sido actualizados en todos los pedidos.");
    }

    document.getElementById('invoiceForm').addEventListener('submit', function (e) {
        e.preventDefault(); // MUY IMPORTANTE: no recargar la p√°gina

        const orderId = parseInt(document.getElementById('invoiceOrderId').value, 10);
        const order = orders.find(o => o.id === orderId);

        if (!order) {
            alert('No se encontr√≥ el pedido a facturar.');
            return;
        }

        // Datos receptor
        const rfcReceptor = document.getElementById('invoiceRfc').value.trim().toUpperCase();
        const razonReceptor = document.getElementById('invoiceRazon').value.trim();
        const cpReceptor = document.getElementById('invoiceCp').value.trim();
        const regimenReceptor = document.getElementById('invoiceRegimenReceptor').value.trim();
        const usoCfdi = document.getElementById('invoiceUsoCfdi').value;
        const emailReceptor = document.getElementById('invoiceEmail').value.trim();

        // Datos pago
        const metodoPago = document.getElementById('invoiceMetodoPago').value;
        const formaPago = document.getElementById('invoiceFormaPago').value;

        // C√°lculo de impuestos (simulado)
        const total = order.total;
        const subtotal = +(total / 1.16).toFixed(2);
        const iva = +(total - subtotal).toFixed(2);

        // Si ya ten√≠a factura, respetamos folio/UUID; si no, generamos
        const previousInvoice = order.invoice;
        const folio = previousInvoice?.folio || `A-${String(order.id).padStart(4, '0')}`;
        const uuid = previousInvoice?.uuid || generateFakeUuid();
        const fechaEmision = previousInvoice?.fecha || new Date().toISOString();

        const invoice = {
            folio,
            uuid,
            fecha: fechaEmision,
            emisor: { ...EMISOR_FISCAL },
            receptor: {
                rfc: rfcReceptor,
                nombre: razonReceptor,
                cp: cpReceptor,
                regimen: regimenReceptor,
                email: emailReceptor || null
            },
            usoCfdi,
            metodoPago,
            formaPago,
            moneda: 'MXN',
            subtotal,
            iva,
            total,
            // Conceptos: se basan en los items del pedido
            conceptos: order.items.map(item => ({
                cantidad: item.quantity,
                descripcion: item.name,
                valorUnitario: item.price,
                importe: +(item.price * item.quantity).toFixed(2)
            }))
        };

        // Guardar la factura dentro del pedido
        order.invoice = invoice;

        // Guardar en localStorage
        saveState();

        closeInvoiceModal();
        renderAdminInvoicing();
        // Mostrar ticket inmediatamente
        openInvoiceTicket(orderId);
        alert('Factura CFDI (simulada) guardada correctamente.');
    });

    function openInvoiceTicket(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order || !order.invoice) {
            alert('Este pedido a√∫n no tiene factura generada.');
            return;
        }

        const inv = order.invoice;

        // Encabezado
        document.getElementById('invoiceTicketEmisorRfc').textContent = inv.emisor.rfc;
        document.getElementById('invoiceTicketFolio').textContent = inv.folio;
        document.getElementById('invoiceTicketUuid').textContent = inv.uuid;
        document.getElementById('invoiceTicketDate').textContent =
            new Date(inv.fecha).toLocaleString();

        document.getElementById('invoiceTicketMetodo').textContent = inv.metodoPago;
        document.getElementById('invoiceTicketForma').textContent = inv.formaPago;

        // Receptor
        document.getElementById('invoiceTicketReceptorRfc').textContent = inv.receptor.rfc;
        document.getElementById('invoiceTicketReceptorNombre').textContent = inv.receptor.nombre;
        document.getElementById('invoiceTicketUsoCfdi').textContent = inv.usoCfdi;
        document.getElementById('invoiceTicketRegimenReceptor').textContent = inv.receptor.regimen;
        document.getElementById('invoiceTicketCpReceptor').textContent = inv.receptor.cp;

        // Conceptos
        const itemsBody = document.getElementById('invoiceTicketItems');
        itemsBody.innerHTML = inv.conceptos.map(c => `
        <tr class="align-top">
            <td class="pr-1">${c.cantidad}</td>
            <td>${c.descripcion}</td>
            <td class="text-right whitespace-nowrap">$${c.importe.toFixed(2)}</td>
        </tr>
    `).join('');

        // Totales
        document.getElementById('invoiceTicketSubtotal').textContent = `$${inv.subtotal.toFixed(2)}`;
        document.getElementById('invoiceTicketIva').textContent = `$${inv.iva.toFixed(2)}`;
        document.getElementById('invoiceTicketTotal').textContent = `$${inv.total.toFixed(2)}`;

        document.getElementById('invoiceTicketModal').classList.remove('hidden');
    }

    function closeInvoiceTicketModal() {
        document.getElementById('invoiceTicketModal').classList.add('hidden');
    }

    // ====================================================================================
    // (Resto de utilidades y formularios existentes)
    // ====================================================================================

    function addMaterialFieldToProductModal(materialId = '', quantity = '') {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const container = document.getElementById('productMaterialsContainer');

        if (container.querySelector('.text-sm.text-gray-500')) {
            container.innerHTML = '';
        }

        const newIndex = container.children.length;
        const materialOptions = rawMaterials.map(m =>
            `<option value="${m.id}" ${m.id == materialId ? 'selected' : ''}>${m.emoji} ${m.name} (${m.unit})</option>`
        ).join('');

        const materialHtml = `
            <div class="flex items-center space-x-2 p-2 bg-white rounded-lg border" data-index="${newIndex}">
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Materia Prima</label>
                    <select name="material_id_${newIndex}" class="w-full border rounded-lg px-2 py-1 text-sm bg-white" required>
                        <option value="">Seleccionar MP</option>
                        ${materialOptions}
                    </select>
                </div>
                <div class="w-20">
                    <label class="block text-xs font-medium mb-1">Cantidad</label>
                    <input type="number" name="material_quantity_${newIndex}" step="0.01" class="w-full border rounded-lg px-2 py-1 text-sm" placeholder="Cantidad" value="${quantity}" required>
                </div>
                <button type="button" onclick="removeMaterialField(this)" class="p-2 bg-red-100 text-red-600 rounded-full self-end hover:bg-red-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', materialHtml);
    }

    function removeMaterialField(button) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const container = document.getElementById('productMaterialsContainer');
        button.closest('.flex').remove();

        if (container.children.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">Haz clic en "A√±adir Materia Prima" para empezar.</p>';
        }
    }

    function renderProductMaterials(product) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const container = document.getElementById('productMaterialsContainer');
        container.innerHTML = '';

        if (product.materialsNeeded && product.materialsNeeded.length > 0) {
            product.materialsNeeded.forEach(mat => {
                addMaterialFieldToProductModal(mat.materialId, mat.quantity);
            });
        } else {
            container.innerHTML = '<p class="text-sm text-gray-500">Haz clic en "A√±adir Materia Prima" para empezar.</p>';
        }
    }

    // FUNCI√ìN MODIFICADA: Se valida el tipo de producto antes de abrir el modal
    function addNewProduct() {
        if (currentAdminProductType === 'supplier') {
            addNewSupplierProduct();
            return;
        }

        document.getElementById('modalTitle').textContent = 'Agregar Producto';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productIsSupplier').value = 'false'; // Asegura que es false
        document.getElementById('productEmoji').value = '';
        document.getElementById('imagePreviewStatus').textContent = 'Ning√∫n archivo seleccionado.';

        // Mostrar campos de receta/tiempo
        document.getElementById('productRecipeSection').classList.remove('hidden');
        document.getElementById('productTimeField').classList.remove('hidden');

        renderProductMaterials({ materialsNeeded: [] });
        document.getElementById('productModal').classList.remove('hidden');
    }

    // FUNCI√ìN MODIFICADA: Se valida el tipo de producto antes de abrir el modal
    function editProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;

        if (product.isSupplierProduct) {
            editSupplierProduct(id);
            return;
        }

        // Producto hecho en casa
        document.getElementById('modalTitle').textContent = 'Editar Producto';
        document.getElementById('productId').value = product.id;
        document.getElementById('productIsSupplier').value = 'false'; // Asegura que es false

        document.getElementById('productName').value = product.name;
        document.getElementById('productEmoji').value = product.emoji || '';
        document.getElementById('productDescription').value = product.description || '';
        document.getElementById('productImageURL').value = product.imageURL || '';
        document.getElementById('productTime').value = product.time || '';
        document.getElementById('productCalories').value = product.calories || '';
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productStock').value = product.stock;

        // Mostrar campos de receta/tiempo
        document.getElementById('productRecipeSection').classList.remove('hidden');
        document.getElementById('productTimeField').classList.remove('hidden');


        if (product.imageLocal) {
            document.getElementById('imagePreviewStatus').textContent = 'Imagen Local Cargada ‚úì';
        } else if (product.imageURL) {
            document.getElementById('imagePreviewStatus').textContent = 'Usando URL ‚úì';
        } else {
            document.getElementById('imagePreviewStatus').textContent = 'Ning√∫n archivo seleccionado.';
        }
        document.getElementById('productImageFile').value = null;

        renderProductMaterials(product);

        document.getElementById('productModal').classList.remove('hidden');
    }

    function deleteProduct(id) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
            products = products.filter(p => p.id !== id);
            saveState();
            renderAdminProducts(currentAdminProductType); // Pasa el tipo de producto actual para refrescar la lista
            renderProducts(); // Refrescar men√∫ cliente
        }
    }

    function closeModal() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        document.getElementById('productModal').classList.add('hidden');
    }

    function toggleOrderStatus(orderId) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const order = orders.find(o => o.id === orderId);
        if (order) {
            order.status = order.status === 'pendiente' ? 'listo' : 'pendiente';
            saveState();
            renderAdminOrders();
        }
    }

    function togglePaymentStatus(orderId) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const order = orders.find(o => o.id === orderId);
        if (order) {
            order.isPaid = !order.isPaid;
            saveState();
            renderAdminOrders();
        }
    }

    function previewLocalImage(event) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const file = event.target.files && event.target.files[0];
        const status = document.getElementById('imagePreviewStatus');
        if (!file) {
            status.textContent = 'Ning√∫n archivo seleccionado.';
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            status.textContent = 'Imagen Local Cargada ‚úì';
        };
        reader.readAsDataURL(file);
    }

    document.getElementById('productForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const id = document.getElementById('productId').value;
        const isSupplierProduct = document.getElementById('productIsSupplier').value === 'true';

        // Redirigir al formulario de producto de proveedor si el flag est√° activo (aunque no deber√≠a suceder si se usa addNew/editProduct)
        if (isSupplierProduct) {
            alert("Error interno: Intentando guardar un producto de proveedor en el formulario de recetas.");
            return;
        }

        const name = document.getElementById('productName').value;
        const emoji = document.getElementById('productEmoji').value.trim().substring(0, 2);
        const price = parseFloat(document.getElementById('productPrice').value);
        const category = document.getElementById('productCategory').value;
        const stock = parseInt(document.getElementById('productStock').value);

        const description = document.getElementById('productDescription').value;
        const imageURL = document.getElementById('productImageURL').value;
        const imageFile = document.getElementById('productImageFile').files[0];
        const time = document.getElementById('productTime').value;
        const calories = document.getElementById('productCalories').value;

        const productMaterialsContainer = document.getElementById('productMaterialsContainer');
        const materialsNeeded = [];

        productMaterialsContainer.querySelectorAll('.flex[data-index]').forEach((item, index) => {
            const materialId = item.querySelector(`[name="material_id_${index}"]`).value;
            const quantity = item.querySelector(`[name="material_quantity_${index}"]`).value;

            if (materialId && quantity > 0) {
                materialsNeeded.push({
                    materialId: parseInt(materialId),
                    quantity: parseFloat(quantity)
                });
            }
        });

        const productToSave = {
            id: id ? parseInt(id) : null,
            name, price, category, stock, emoji,
            materialsNeeded: materialsNeeded,
            isSupplierProduct: false, // Producto hecho en casa
            description, time, calories,
            imageURL: '', imageLocal: '',
        };

        const existingProduct = id ? products.find(p => p.id === parseInt(id)) : null;

        const finalizeSave = (localData = null) => {
            if (localData) {
                productToSave.imageLocal = localData;
                productToSave.imageURL = '';
            } else if (imageURL) {
                productToSave.imageURL = imageURL;
                productToSave.imageLocal = '';
            } else if (existingProduct) {
                productToSave.imageLocal = existingProduct.imageLocal || '';
                productToSave.imageURL = existingProduct.imageURL || '';
            }

            if (id) {
                Object.assign(products.find(p => p.id === parseInt(id)), productToSave);
            } else {
                const newId = Math.max(...products.map(p => p.id), 0) + 1;
                productToSave.id = newId;
                products.push(productToSave);
            }

            saveState();
            renderAdminProducts(currentAdminProductType);
            renderProducts(); // Actualizar men√∫ cliente
            closeModal();
        };

        if (imageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
                finalizeSave(e.target.result);
            };
            reader.readAsDataURL(imageFile);
        } else {
            finalizeSave();
        }
    });

    document.getElementById('cardNumber').addEventListener('input', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
        e.target.value = formattedValue;
    });

    document.getElementById('cardExpiry').addEventListener('input', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });

    document.getElementById('cardCvv').addEventListener('input', function (e) {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    loadState();

    // ========================= R E P O R T E S¬† (Vista previa + Copiar) =========================

    function showAdminReports() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        activateTab('reportsTab');
        document.getElementById('adminReportsSection').classList.remove('hidden');
        renderReportPreview();
    }

    function generateReportText() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const now = new Date();
        const d = (n) => String(n).padStart(2, '0');
        const iso = `${now.getFullYear()}-${d(now.getMonth() + 1)}-${d(now.getDate())} ${d(now.getHours())}:${d(now.getMinutes())}:${d(now.getSeconds())}`;

        const usersSafe = Array.isArray(users) ? users : [];
        const productsSafe = Array.isArray(products) ? products : [];

        const lines = [];
        lines.push("==============================================");
        lines.push("¬† ¬† ¬† ¬† ¬† ¬† ¬† CAFE-TEC ‚Äî REPORTE TXT¬† ¬† ¬† ¬† ¬† ¬† ");
        lines.push("==============================================");
        lines.push(`Generado: ${iso}`);
        lines.push("");

        lines.push("USUARIOS");
        lines.push("--------");
        if (usersSafe.length === 0) {
            lines.push("(sin usuarios)");
        } else {
            usersSafe
                .filter(u => u && u.id !== 0)
                .forEach((u, idx) => {
                    const regDate = (u.registrationDate instanceof Date)
                        ? u.registrationDate
                        : (u.registrationDate ? new Date(u.registrationDate) : null);
                    const regStr = regDate ? regDate.toLocaleString() : "N/D";
                    lines.push(`#${idx + 1}`);
                    lines.push(`- Nombre: ${u.fullName || "N/D"}`);
                    lines.push(`- Usuario: ${u.username || "N/D"}`);
                    lines.push(`- Tipo: ${u.userType || "N/D"}`);
                    lines.push(`- Estado: ${u.isActive === false ? "DESACTIVADA" : "ACTIVA"}`);
                    if (u.userType === 'estudiante') {
                        lines.push(`- No. Control: ${u.controlNumber || "N/D"}`);
                        lines.push(`- Carrera: ${u.career || "N/D"}`);
                        lines.push(`- Semestre: ${u.semester || "N/D"}`);
                        lines.push(`- Grupo: ${u.group || "N/D"}`);
                    } else {
                        lines.push(`- Tel√©fono: ${u.phoneNumber || "N/D"}`);
                    }
                    lines.push(`- Credencial: ${u.hasCredential ? "S√≠" : "No"}`);
                    lines.push(`- Fecha Registro: ${regStr}`);
                    lines.push("");
                });
        }

        lines.push("");
        lines.push("PRODUCTOS");
        lines.push("---------");
        if (productsSafe.length === 0) {
            lines.push("(sin productos)");
        } else {
            productsSafe.forEach((p, idx) => {
                lines.push(`#${idx + 1}`);
                lines.push(`- Nombre: ${p.name || "N/D"}`);
                lines.push(`- Emoji: ${p.emoji || "‚Äî"}`);
                lines.push(`- Categor√≠a: ${p.category || "N/D"}`);
                lines.push(`- Precio: $${(p.price ?? 0).toFixed(2)}`);
                lines.push(`- Stock: ${p.stock ?? 0}`);

                // Muestra si es de proveedor o hecho en casa
                lines.push(`- Origen: ${p.isSupplierProduct ? "Proveedor" : "Hecho en Casa"}`);

                if (p.time) lines.push(`- Tiempo: ${p.time}`);
                if (p.calories) lines.push(`- Calor√≠as: ${p.calories}`);
                if (p.description) lines.push(`- Descripci√≥n: ${p.description}`);

                if (Array.isArray(p.materialsNeeded) && p.materialsNeeded.length > 0) {
                    lines.push("- Receta por unidad:");
                    p.materialsNeeded.forEach(mat => {
                        const rm = getRawMaterial(mat.materialId);
                        if (rm) {
                            lines.push(`¬† ‚Ä¢ ${mat.quantity} ${rm.unit} de ${rm.name}`);
                        } else {
                            lines.push(`¬† ‚Ä¢ ${mat.quantity} (MP id ${mat.materialId})`);
                        }
                    });
                } else if (!p.isSupplierProduct) {
                    lines.push("- Receta por unidad: (sin receta vinculada)");
                }

                lines.push("");
            });
        }

        return lines.join("\n");
    }

    function renderReportPreview() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const previewEl = document.getElementById('reportPreview');
        const summaryEl = document.getElementById('reportSummary');
        if (!previewEl) return;

        const text = generateReportText();
        previewEl.value = text;

        const usersCount = (Array.isArray(users) ? users.filter(u => u && u.id !== 0).length : 0);
        const productsCount = (Array.isArray(products) ? products.length : 0);
        summaryEl.textContent = `${usersCount} usuarios, ${productsCount} productos ‚Äî generado ${new Date().toLocaleString()}`;
    }

    function copyReportToClipboard() {
        // ... (Esta funci√≥n se mantiene igual que la original) ...
        const previewEl = document.getElementById('reportPreview');
        if (!previewEl) return;
        const text = previewEl.value || "";

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text)
                .then(() => alert("Reporte copiado al portapapeles."))
                .catch(() => fallbackCopy(previewEl));
        } else {
            fallbackCopy(previewEl);
        }

        function fallbackCopy(el) {
            el.removeAttribute('readonly');
            el.select();
            el.setSelectionRange(0, el.value.length);
            const ok = document.execCommand('copy');
            el.setAttribute('readonly', 'readonly');
            window.getSelection().removeAllRanges();
            alert(ok ? "Reporte copiado al portapapeles." : "No se pudo copiar. Selecciona y copia manualmente.");
        }
    }
    const reports = document.getElementById('adminReportsSection');
    if (reports && !reports.classList.contains('hidden')) {
        renderReportPreview();
    }

</script>
</body>
<html>
